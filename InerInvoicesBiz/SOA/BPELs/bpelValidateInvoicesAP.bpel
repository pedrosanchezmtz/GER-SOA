<?xml version = "1.0" encoding = "UTF-8" ?>
<?xml-stylesheet type="text/xsl" href="bpelStyle.xsl"?>
<!--
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  Oracle JDeveloper BPEL Designer 
  
  Created: Wed Dec 13 14:01:28 CST 2017
  Author:  coco
  Type: BPEL 2.0 Process
  Purpose: Asynchronous BPEL Process
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
-->
<process name="bpelValidateInvoicesAP"
         targetNamespace="http://soa.estrellaroja.com.mx/InvoicesBiz/bpelValidateInvoicesAP"
         xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
         xmlns:client="http://soa.estrellaroja.com.mx/InvoicesBiz/bpelValidateInvoicesAP"
         xmlns:ora="http://schemas.oracle.com/xpath/extension" xmlns:ui="http://xmlns.oracle.com/soa/designer"
         xmlns:bpelx="http://schemas.oracle.com/bpel/extension"
         xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
         xmlns:ns1="http://soa.estrellaroja.com.mx/ERPIntegrationServiceTec"
         xmlns:cmn="http://soa.estrellaroja.com.mx/EstrellaRojaCommons"
         xmlns:oraext="http://www.oracle.com/XSL/Transform/java/oracle.tip.pc.services.functions.ExtFunc"
         xmlns:bpm="http://xmlns.oracle.com/bpmn20/extensions"
         xmlns:xp20="http://www.oracle.com/XSL/Transform/java/oracle.tip.pc.services.functions.Xpath20"
         xmlns:ess="http://xmlns.oracle.com/scheduler" xmlns:hwf="http://xmlns.oracle.com/bpel/workflow/xpath"
         xmlns:xref="http://www.oracle.com/XSL/Transform/java/oracle.tip.xref.xpath.XRefXPathFunctions"
         xmlns:dvm="http://www.oracle.com/XSL/Transform/java/oracle.tip.dvm.LookupValue"
         xmlns:bpws="http://schemas.xmlsoap.org/ws/2003/03/business-process/"
         xmlns:xdk="http://schemas.oracle.com/bpel/extension/xpath/function/xdk"
         xmlns:ids="http://xmlns.oracle.com/bpel/services/IdentityService/xpath"
         xmlns:ns2="http://soa.estrellaroja.com.mx/InvoicesBiz"
         xmlns:ldap="http://schemas.oracle.com/xpath/extension/ldap"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xmlns:ns3="http://soa.estrellaroja.com.mx/SOAUtilitiesTec" xmlns:xsd="http://www.w3.org/2001/XMLSchema"
         xmlns:ns4="http://soa.estrellaroja.com.mx/ElectronicInvoiceAP"
         xmlns:ns5="http://soa.estrellaroja.com.mx/DigitalStampTec"
         xmlns:sp1="http://soa.estrellaroja.com.mx//InvoicesBiz/sbpelHoldInvoicesAP"
         xmlns:ns0="http://soa.estrellaroja.com.mx/InvoicesBiz/sbpelReleaseInvoicesAP"
         xmlns:ns6="http://soa.estrellaroja.com.mx/InvoicesBiz/sbpelNotifyHtmlControl"
         xmlns:ns7="http://soa.estrellaroja.com.mx/AuditControlTec" xmlns:ns8="http://soa.estrellaroja.com.mx/cfd/3"
         xmlns:ns9="http://soa.estrellaroja.com.mx/TimbreFiscalDigital"
         xmlns:ns10="http://soa.estrellaroja.com.mx/ValidacionAutomaticTec"
         xmlns:ns11="http://soa.estrellaroja.com.mx/ValidacionAutomaticTec"
         xmlns:ns12="http://xmlns.oracle.com/apps/financials/commonModules/shared/model/erpIntegrationService/"
         xmlns:ns13="http://xmlns.oracle.com/apps/financials/payables/invoices/transactions/invoiceService/"
         xmlns:ns14="http://xmlns.oracle.com/apps/financials/payables/invoices/transactions/invoiceService/types/"
         xmlns:ns15="http://xmlns.oracle.com/pcbpel/adapter/db/PROD_InvoicesBiz/InvoicesBiz/dbValidaAutomatic"
         xmlns:ns16="http://xmlns.oracle.com/pcbpel/adapter/db/top/dbValidaAutomatic"
         xmlns:ns17="http://soa.estrellaroja.com.mx/ERPIntegrationApiTec" xmlns:ns18="http://www.sat.gob.mx/cfd/4"
         xmlns:ns21="http://www.sat.gob.mx/ConsumoDeCombustibles11"
         xmlns:ns19="http://www.sat.gob.mx/TimbreFiscalDigital"
         xmlns:ns22="http://www.sat.gob.mx/EstadoDeCuentaCombustible12" xmlns:ns20="http://www.sat.gob.mx/CartaPorte20"
         xmlns:ns23="http://www.sat.gob.mx/nomina12" xmlns:ns24="http://www.sat.gob.mx/Pagos20"
         xmlns:ns25="http://soa.estrellaroja.com.mx/InvoicesBiz/sbpelSenNotificationValidation">
    <import namespace="http://www.sat.gob.mx/cfd/4" location="oramds:/apps/Common/XSD/CFDI40/cfdv40.xsd"
            importType="http://www.w3.org/2001/XMLSchema"/>
    <import namespace="http://soa.estrellaroja.com.mx/cfd/3" location="../Schemas/CFDIGER/cfdv33.xsd"
            importType="http://www.w3.org/2001/XMLSchema"/>
   
    
    <import namespace="http://soa.estrellaroja.com.mx/ElectronicInvoiceAP" location="../Schemas/ElectronicInvoiceAP.xsd"
            importType="http://www.w3.org/2001/XMLSchema"/>
    <import ui:processWSDL="true" namespace="http://soa.estrellaroja.com.mx/InvoicesBiz/bpelValidateInvoicesAP"
            location="../WSDLs/bpelValidateInvoicesAP.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import location="oracle.xml.parser.v2.XMLElement" importType="http://schemas.oracle.com/bpel/extension/java"/>
    <import location="javax.xml.transform.OutputKeys" importType="http://schemas.oracle.com/bpel/extension/java"/>
<import location="javax.xml.transform.Transformer" importType="http://schemas.oracle.com/bpel/extension/java"/>
<import location="javax.xml.transform.TransformerFactory" importType="http://schemas.oracle.com/bpel/extension/java"/>
<import location="javax.xml.transform.dom.DOMSource" importType="http://schemas.oracle.com/bpel/extension/java"/>
<import location="javax.xml.transform.stream.StreamResult" importType="http://schemas.oracle.com/bpel/extension/java"/>
    <import location="org.w3c.dom.Document" importType="http://schemas.oracle.com/bpel/extension/java"/>
    <import location="org.xml.sax.InputSource" importType="http://schemas.oracle.com/bpel/extension/java"/>
    <import location="java.io.StringReader" importType="http://schemas.oracle.com/bpel/extension/java"/>
    <import location="java.io.StringWriter" importType="http://schemas.oracle.com/bpel/extension/java"/>
    <!-- 
      ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        PARTNERLINKS                                                      
        List of services participating in this BPEL process               
      ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    -->
    <partnerLinks>
        <!-- 
      The 'client' role represents the requester of this service. It is 
      used for callback. The location and correlation information associated
      with the client role are automatically set using WS-Addressing.
    -->
        <partnerLink name="bpelvalidateinvoicesap" partnerLinkType="client:bpelValidateInvoicesAP"
                     myRole="bpelValidateInvoicesAPProvider" partnerRole="bpelValidateInvoicesAPRequester"/>
        <partnerLink name="wsSOAUtilitiesTec" partnerLinkType="ns3:wsSOAUtilitiesTec"
                     partnerRole="SOAUtilitiesTecPortType"/>
        <partnerLink name="wsERPIntegrationServiceTec" partnerLinkType="ns1:wsERPIntegrationServiceTec"
                     partnerRole="ERPIntegrationTecPortType"/>
        <partnerLink name="wsAuditControlTecPs" partnerLinkType="ns7:wsAuditControlTecPs"
                     partnerRole="AuditControlTecPortType"/>
        <partnerLink name="wsErpIntegrationServicevA" partnerLinkType="ns12:ErpIntegrationService"
                     partnerRole="ErpIntegrationServiceProvider" myRole="ErpIntegrationServiceRequestor"/>
        <partnerLink name="wsInvoiceServiceCr" partnerLinkType="ns13:InvoiceService"
                     partnerRole="InvoiceServiceProvider" myRole="InvoiceServiceRequestor"/>
        <partnerLink name="wsERPIntegrationApiTec" partnerLinkType="ns17:wsERPIntegrationApiTec"
                     partnerRole="postInvoicePortType"/>
        <partnerLink name="ValidationAutomatTec" partnerLinkType="ns11:ERPValidacionConsultBS"
                     partnerRole="ERPValidacionConsultBSProvider"/>
    </partnerLinks>
    <!-- 
      ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        VARIABLES                                                        
        List of messages and XML documents used within this BPEL process 
      ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    -->
    <variables>
        <!-- Reference to the message passed as input during initiation -->
        <variable name="inputVariable" messageType="client:bpelValidateInvoicesAPRequestMessage"/>
        <!-- Reference to the message that will be sent back to the requester during callback -->
        <variable name="outputVariable" messageType="client:bpelValidateInvoicesAPResponseMessage"/>
                 <variable name="varInvoiceAP" element="ns2:InvoiceAP"/>
        <variable name="InvokeValidatiAutomIntPut" messageType="ns10:ValidaOracleXml_inputMessage"/>
        <variable name="InvokeValidatiAutomOutPut" messageType="ns10:ValidaOracleXml_outputMessage"/>
        <variable name="ConsultaSatCFDIEn" messageType="ns10:ConsultaSatCFDI_inputMessage"/>
        <variable name="ConsultaSatCFDISa" messageType="ns10:ConsultaSatCFDI_outputMessage"/>
        <variable name="submitIntPut" messageType="ns12:ErpIntegrationService_submitESSJobRequest"/>
        <variable name="submitOutPut" messageType="ns12:ErpIntegrationService_submitESSJobRequestResponse"/>
        <variable name="CancelInvoiceInt" messageType="ns13:InvoiceService_cancelInvoice"/>
        <variable name="CancelInvoiceOut" messageType="ns13:InvoiceService_cancelInvoiceResponse"/>
        <variable name="RetieneFacInt" messageType="ns13:InvoiceService_releaseSingleHold"/>
        <variable name="RetieneFacOut" messageType="ns13:InvoiceService_releaseSingleHoldResponse"/>
        <variable name="v_pruebas" type="xsd:boolean">
            <from>false()</from>
        </variable>
    </variables>
    <faultHandlers>
        <catchAll>
            <documentation>
                <![CDATA[Control de cualquier excepción no conocida o no manejada específicamente. Se indica a nivel global del BPEL.]]>
            </documentation>
            <sequence name="sequenceCatchAll">
                <documentation>
                    <![CDATA[Secuencia de actividades para preparar la salida del proceso BPEL una vez que se ha atrapado una excepción no conocida o no controlada de forma específica.]]>
                </documentation>
                <assign name="assignCatchAll">
                    <documentation>
                        <![CDATA[Se asigna la información correspondiente a la excepción CatchAll en el nodo de errores.]]>
                    </documentation>
                    <copy bpelx:insertMissingToData="yes">
                        <from><literal>SOA-00001</literal></from>
                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$outputVariable.payload/cmn:Errors/cmn:Error/cmn:ErrorCode</to>
                    </copy>
                    <copy bpelx:insertMissingToData="yes">
                        <from>ora:getFaultName()</from>
                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$outputVariable.payload/cmn:Errors/cmn:Error/cmn:ShortDescription</to>
                    </copy>
                    <copy bpelx:insertMissingToData="yes">
                        <from>concat('Unknown error in service integration: ',ora:getFaultAsString())</from>
                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$outputVariable.payload/cmn:Errors/cmn:Error/cmn:Description</to>
                    </copy>
                    <copy bpelx:insertMissingToData="yes">
                        <from><literal>[ValidateInvoicesAP]</literal></from>
                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$outputVariable.payload/cmn:Errors/cmn:Error/cmn:BusinessProcess</to>
                    </copy>
                    <copy bpelx:insertMissingToData="yes">
                        <from><literal>[InvoicesEnt]</literal></from>
                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$outputVariable.payload/cmn:Errors/cmn:Error/cmn:FailedService</to>
                    </copy>
                    <copy bpelx:insertMissingToData="yes">
                        <from>xp20:current-dateTime()</from>
                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$outputVariable.payload/cmn:Errors/cmn:Error/cmn:TimeStamp</to>
                    </copy>
                    <copy bpelx:insertMissingToData="yes">
                        <from><literal><Element xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable"/></literal></from>
                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$outputVariable.payload/cmn:Success</to>
                    </copy>
                    <extensionAssignOperation>
                        <bpelx:remove>
                            <?audit suppress oracle.ide.xml.validation-incomplete?>
                            <bpelx:target expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$outputVariable.payload/cmn:Success</bpelx:target>
                        </bpelx:remove>
                    </extensionAssignOperation>
                </assign>
                <invoke name="callbackClient" bpelx:invokeAsDetail="no" partnerLink="bpelvalidateinvoicesap"
                        portType="client:bpelValidateInvoicesAPCallback" operation="ValidateInvoicesAPCallback"
                        inputVariable="outputVariable"/>
            </sequence>
        </catchAll>
    </faultHandlers>
    <!-- 
      ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
       ORCHESTRATION LOGIC                                               
       Set of activities coordinating the flow of messages across the    
       services integrated within this business process                  
      ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    -->
    <sequence name="sequenceMain">
        <!-- Receive input from requestor. (Note: This maps to operation defined in bpelValidateInvoicesAP.wsdl) -->
        <receive name="receiveInput" partnerLink="bpelvalidateinvoicesap" portType="client:bpelValidateInvoicesAP"
                 operation="ValidateInvoicesAP" variable="inputVariable" createInstance="yes"/>
        <scope name="scopeValidateInvoicesAP">
            <variables>
                <variable name="varValidatePaymentRq" element="ns4:ValidatePaymentRq"/>
                <variable name="varCountTotal" element="ns4:HelperInteger"/>
                <variable name="varCountErrors" element="ns4:HelperInteger">
                    <from>0</from>
                </variable>
                <variable name="varCountSuccess" element="ns4:HelperInteger">
                    <from>0</from>
                </variable>
                <variable name="htmlInput" messageType="ns3:GetHtmlControlRq"/>
            </variables>
            <faultHandlers>
                <catch bpelx:name="Timeout" faultName="bpelx:timeout">
                    <documentation>
                        <![CDATA[Control para excepción por Tiempo Expirado durante la llamada a un servicio externo invocado.]]>
                    </documentation>
                    <assign name="assignTimeout">
                        <documentation>
                            <![CDATA[Se asignan los valores correspondientes de la excepción controlada al nodo de Errores que se encuentra en la variable de salida del BPEL.]]>
                        </documentation>
                        <copy bpelx:insertMissingToData="yes">
                            <from><literal>SOA-00002</literal></from>
                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$outputVariable.payload/cmn:Errors/cmn:Error/cmn:ErrorCode</to>
                        </copy>
                        <copy bpelx:insertMissingToData="yes">
                            <from>ora:getFaultName()</from>
                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$outputVariable.payload/cmn:Errors/cmn:Error/cmn:ShortDescription</to>
                        </copy>
                        <copy bpelx:insertMissingToData="yes">
                            <from>concat('Exception maxed timeout. ',ora:getFaultAsString())</from>
                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$outputVariable.payload/cmn:Errors/cmn:Error/cmn:Description</to>
                        </copy>
                        <copy bpelx:insertMissingToData="yes">
                            <from><literal>[ValidateInvoicesAP]</literal></from>
                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$outputVariable.payload/cmn:Errors/cmn:Error/cmn:BusinessProcess</to>
                        </copy>
                        <copy bpelx:insertMissingToData="yes">
                            <from><literal>[InvoicesEnt]</literal></from>
                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$outputVariable.payload/cmn:Errors/cmn:Error/cmn:FailedService</to>
                        </copy>
                        <copy bpelx:insertMissingToData="yes">
                            <from>xp20:current-dateTime()</from>
                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$outputVariable.payload/cmn:Errors/cmn:Error/cmn:TimeStamp</to>
                        </copy>
                        <copy bpelx:insertMissingToData="yes">
                            <from><literal><Element xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable"/></literal></from>
                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$outputVariable.payload/cmn:Success</to>
                        </copy>
                        <extensionAssignOperation>
                            <bpelx:remove>
                                <?audit suppress oracle.ide.xml.validation-incomplete?>
                                <bpelx:target expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$outputVariable.payload/cmn:Success</bpelx:target>
                            </bpelx:remove>
                        </extensionAssignOperation>
                    </assign>
                </catch>
                <catch bpelx:name="Remote Fault" faultName="bpelx:remoteFault">
                    <documentation>
                        <![CDATA[Control para excepción por Falla Remota a servicio externo invocado.]]>
                    </documentation>
                    <assign name="assignRemoteFault">
                        <documentation>
                            <![CDATA[Se asignan los valores correspondientes de la excepción controlada al nodo de Errores que se encuentra en la variable de salida del BPEL.]]>
                        </documentation>
                        <copy bpelx:insertMissingToData="yes">
                            <from><literal>SOA-00005</literal></from>
                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$outputVariable.payload/cmn:Errors/cmn:Error/cmn:ErrorCode</to>
                        </copy>
                        <copy bpelx:insertMissingToData="yes">
                            <from>ora:getFaultName()</from>
                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$outputVariable.payload/cmn:Errors/cmn:Error/cmn:ShortDescription</to>
                        </copy>
                        <copy bpelx:insertMissingToData="yes">
                            <from>concat('Exception when trying to invoke a remote service. ',ora:getFaultAsString())</from>
                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$outputVariable.payload/cmn:Errors/cmn:Error/cmn:Description</to>
                        </copy>
                        <copy bpelx:insertMissingToData="yes">
                            <from><literal>[ValidateInvoicesAP]</literal></from>
                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$outputVariable.payload/cmn:Errors/cmn:Error/cmn:BusinessProcess</to>
                        </copy>
                        <copy bpelx:insertMissingToData="yes">
                            <from><literal>[InvoicesEnt]</literal></from>
                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$outputVariable.payload/cmn:Errors/cmn:Error/cmn:FailedService</to>
                        </copy>
                        <copy bpelx:insertMissingToData="yes">
                            <from>xp20:current-dateTime()</from>
                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$outputVariable.payload/cmn:Errors/cmn:Error/cmn:TimeStamp</to>
                        </copy>
                        <copy bpelx:insertMissingToData="yes">
                            <from><literal><Element xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable"/></literal></from>
                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$outputVariable.payload/cmn:Success</to>
                        </copy>
                        <extensionAssignOperation>
                            <bpelx:remove>
                                <?audit suppress oracle.ide.xml.validation-incomplete?>
                                <bpelx:target expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$outputVariable.payload/cmn:Success</bpelx:target>
                            </bpelx:remove>
                        </extensionAssignOperation>
                    </assign>
                </catch>
                <catch bpelx:name="Selection Failure" faultName="bpel:selectionFailure">
                    <documentation>
                        <![CDATA[Control para excepción por Falla en Selección.]]>
                    </documentation>
                    <assign name="assignSelectionFailure">
                        <documentation>
                            <![CDATA[Se asignan los valores correspondientes de la excepción controlada al nodo de Errores que se encuentra en la variable de salida del BPEL.]]>
                        </documentation>
                        <copy bpelx:insertMissingToData="yes">
                            <from><literal>SOA-00004</literal></from>
                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$outputVariable.payload/cmn:Errors/cmn:Error/cmn:ErrorCode</to>
                        </copy>
                        <copy bpelx:insertMissingToData="yes">
                            <from>ora:getFaultName()</from>
                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$outputVariable.payload/cmn:Errors/cmn:Error/cmn:ShortDescription</to>
                        </copy>
                        <copy bpelx:insertMissingToData="yes">
                            <from>concat('There have been exceptions when trying to select and set variables. ',ora:getFaultAsString())</from>
                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$outputVariable.payload/cmn:Errors/cmn:Error/cmn:Description</to>
                        </copy>
                        <copy bpelx:insertMissingToData="yes">
                            <from><literal>[ValidateInvoicesAP]</literal></from>
                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$outputVariable.payload/cmn:Errors/cmn:Error/cmn:BusinessProcess</to>
                        </copy>
                        <copy bpelx:insertMissingToData="yes">
                            <from><literal>[InvoicesEnt]</literal></from>
                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$outputVariable.payload/cmn:Errors/cmn:Error/cmn:FailedService</to>
                        </copy>
                        <copy bpelx:insertMissingToData="yes">
                            <from>xp20:current-dateTime()</from>
                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$outputVariable.payload/cmn:Errors/cmn:Error/cmn:TimeStamp</to>
                        </copy>
                        <copy bpelx:insertMissingToData="yes">
                            <from><literal><Element xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable"/></literal></from>
                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$outputVariable.payload/cmn:Success</to>
                        </copy>
                        <extensionAssignOperation>
                            <bpelx:remove>
                                <?audit suppress oracle.ide.xml.validation-incomplete?>
                                <bpelx:target expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$outputVariable.payload/cmn:Success</bpelx:target>
                            </bpelx:remove>
                        </extensionAssignOperation>
                    </assign>
                </catch>
                <catch bpelx:name="Invalid Variables" faultName="bpel:invalidVariables">
                    <documentation>
                        <![CDATA[Control para excepción por Variables No Válidas.]]>
                    </documentation>
                    <assign name="assignInvalidVariables">
                        <documentation>
                            <![CDATA[Se asignan los valores correspondientes de la excepción controlada al nodo de Errores que se encuentra en la variable de salida del BPEL.]]>
                        </documentation>
                        <copy bpelx:insertMissingToData="yes">
                            <from><literal>SOA-00003</literal></from>
                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$outputVariable.payload/cmn:Errors/cmn:Error/cmn:ErrorCode</to>
                        </copy>
                        <copy bpelx:insertMissingToData="yes">
                            <from>ora:getFaultName()</from>
                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$outputVariable.payload/cmn:Errors/cmn:Error/cmn:ShortDescription</to>
                        </copy>
                        <copy bpelx:insertMissingToData="yes">
                            <from>concat('There have been exceptions when trying set values in variables. ',ora:getFaultAsString())</from>
                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$outputVariable.payload/cmn:Errors/cmn:Error/cmn:Description</to>
                        </copy>
                        <copy bpelx:insertMissingToData="yes">
                            <from><literal>[ValidateInvoicesAP]</literal></from>
                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$outputVariable.payload/cmn:Errors/cmn:Error/cmn:BusinessProcess</to>
                        </copy>
                        <copy bpelx:insertMissingToData="yes">
                            <from><literal>[InvoicesEnt]</literal></from>
                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$outputVariable.payload/cmn:Errors/cmn:Error/cmn:FailedService</to>
                        </copy>
                        <copy bpelx:insertMissingToData="yes">
                            <from>xp20:current-dateTime()</from>
                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$outputVariable.payload/cmn:Errors/cmn:Error/cmn:TimeStamp</to>
                        </copy>
                        <copy bpelx:insertMissingToData="yes">
                            <from><literal><Element xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable"/></literal></from>
                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$outputVariable.payload/cmn:Success</to>
                        </copy>
                        <extensionAssignOperation>
                            <bpelx:remove>
                                <?audit suppress oracle.ide.xml.validation-incomplete?>
                                <bpelx:target expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$outputVariable.payload/cmn:Success</bpelx:target>
                            </bpelx:remove>
                        </extensionAssignOperation>
                    </assign>
                </catch>
            </faultHandlers>
            <sequence name="sequenceValidateInvoicesAP"><assign name="AssignPruebas"
                                                                xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable">
      <bpelx:skipCondition xmlns:bpelx="http://schemas.oracle.com/bpel/extension">dvm:lookupValue("DVMs/dvmInvoicesBiz.dvm","Code","Pruebas","Value","false","Component","ValidateInvoicesAP")!='true'</bpelx:skipCondition>
                    <copy>
                        <from>true()</from>
                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$v_pruebas</to>
                    </copy>
                    <copy>
                        <from>dvm:lookupValue("DVMs/dvmInvoicesBiz.dvm","Code","EmailPruebas","Value","pedro.sanchez@forteinnovation.mx","Component","ValidateInvoicesAP")</from>
                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$inputVariable.payload/ns2:InvoicesAP/ns2:InvoiceAP/ns2:OrdereMail</to>
                    </copy>
                    <copy>
                        <from>'NEVER APPROVED'</from>
                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$inputVariable.payload/ns2:InvoicesAP/ns2:InvoiceAP/ns2:ApprovalStatus</to>
                    </copy>
                    <copy>
                        <from>'No validada'</from>
                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$inputVariable.payload/ns2:InvoicesAP/ns2:InvoiceAP/ns2:Status</to>
                    </copy>
                </assign><scope name="scopeCallSBpelInsertHold">
                    <bpelx:skipCondition>$v_pruebas</bpelx:skipCondition>
                    <variables>
                        <variable name="varSBpelHoldInvoicesAPRs" element="ns2:ValidateInvoicesAPRs"/>
                        <variable name="varHoldInvoicesAPRq" element="ns2:ValidateInvoicesAPRq"/>
                    </variables>
                    <sequence name="sequenceInsertHold">
                        <assign name="assignClearNodes">
                            <copy bpelx:insertMissingToData="yes">
                                <from><literal><Element xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable"/></literal></from>
                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$outputVariable.payload/cmn:Errors/cmn:Error</to>
                            </copy>
                            <copy bpelx:insertMissingToData="yes">
                                <from><literal><Element xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable"/></literal></from>
                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varValidatePaymentRq/ns4:Payment</to>
                            </copy>
                            <extensionAssignOperation>
                                <bpelx:remove>
                                    <bpelx:target expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varValidatePaymentRq/ns4:Payment</bpelx:target>
                                </bpelx:remove>
                            </extensionAssignOperation>
                            <extensionAssignOperation>
                                <bpelx:remove>
                                    <bpelx:target expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$outputVariable.payload/cmn:Errors/cmn:Error</bpelx:target>
                                </bpelx:remove>
                            </extensionAssignOperation>
                            <copy ignoreMissingFromData="yes" bpelx:insertMissingToData="yes">
                                <from>$inputVariable.payload/ns2:InvoicesAP</from>
                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varHoldInvoicesAPRq/ns2:InvoicesAP</to>
                            </copy>
                            <copy ignoreMissingFromData="yes" bpelx:insertMissingToData="yes">
                                <from>count($inputVariable.payload/ns2:InvoicesAP/ns2:InvoiceAP)</from>
                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varCountTotal</to>
                            </copy>
                        </assign>
                        <extensionActivity>
                            <bpelx:call name="callSBpelHoldInvoices"
                                        xmlns:sp1="http://soa.estrellaroja.com.mx//InvoicesBiz/sbpelHoldInvoicesAP"
                                        target="sp1:sbpelHoldInvoicesAP">
                                <bpelx:param name="varHoldInvoicesAPRq" copyByValue="yes"
                                             variable="varHoldInvoicesAPRq"/>
                                <bpelx:param name="varHoldInvoicesAPRs" copyByValue="no"
                                             variable="varSBpelHoldInvoicesAPRs"/>
                            </bpelx:call>
                        </extensionActivity>
                        <if name="ifSuccessHold">
                            <documentation>
                                <![CDATA[Continue]]>
                            </documentation>
                            <condition expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">count($varSBpelHoldInvoicesAPRs/cmn:Success) &gt;0</condition>
                            <empty name="empty"/>
                            <else>
                                <documentation>
                                    <![CDATA[CatchErrors]]>
                                </documentation>
                                <sequence name="sequenceErrors">
                                    <assign name="assignErrors">
                                        <extensionAssignOperation>
                                            <bpelx:append>
                                                <bpelx:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varSBpelHoldInvoicesAPRs/cmn:Errors/cmn:Error</bpelx:from>
                                                <bpelx:to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$outputVariable.payload/cmn:Errors</bpelx:to>
                                            </bpelx:append>
                                        </extensionAssignOperation>
                                        <copy bpelx:insertMissingToData="yes" ignoreMissingFromData="yes">
                                            <from>$varCountErrors + count($varSBpelHoldInvoicesAPRs/cmn:Errors/cmn:Error)</from>
                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varCountErrors</to>
                                        </copy>
                                    </assign>
                                    <assign name="xqyVarSBpelHoldInvoicesRs_To_InputVariable">
                                        <bpelx:annotation>
                                            <bpelx:pattern patternName="bpelx:xquery"></bpelx:pattern>
                                        </bpelx:annotation>
                                        <copy>
                                            <from>ora:processXQuery10('../Transformations/XQueries/xqyVarSBpelHoldInvoicesRs_To_InputVariable.xqy', 'inputVariable.payload', $inputVariable.payload, 'varSBpelHoldInvoicesAPRs', $varSBpelHoldInvoicesAPRs)</from>
                                            <to variable="inputVariable" part="payload"/>
                                        </copy>
                                    </assign>
                                </sequence>
                            </else>
                        </if>
                    </sequence>
                </scope>
                <forEach parallel="no" counterName="counterInvoices" name="forEachValidateInvoices">
                    <startCounterValue expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">1</startCounterValue>
                    <finalCounterValue expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">count($inputVariable.payload/ns2:InvoicesAP/ns2:InvoiceAP)</finalCounterValue>
                    <scope name="scopeForEachValidateInvoices">
                        <variables>
                            <variable name="invoikeWsERPIntegrationServiceTecDownloadAttachmentRq"
                                      messageType="ns1:DownloadAttachmentRq"/>
                            <variable name="invoikeWsERPIntegrationServiceTecDownloadAttachmentRs"
                                      messageType="ns1:DownloadAttachmentRs"/>
                            <variable name="invokeWsSOAUtilitiesTecDecodeRq" messageType="ns3:DecodeRq"/>
                            <variable name="invokeWsSOAUtilitiesTecDecodeRs" messageType="ns3:DecodeRs"/>
                            <variable name="varContinue" type="xsd:boolean">
                                <from>true()</from>
                            </variable>
                            <variable name="varError" element="cmn:Error"/>
                            <variable name="wsERPintegrationApiTec_postInvoiceRq"
                                      messageType="ns17:postInvoiceRqMessage"/>
                            <variable name="wsERPintegrationApiTec_postInvoiceRs"
                                      messageType="ns17:postInvoiceRsMessage"/>
                            <variable name="MergeReportValidationRq"
                                      messageType="ns11:MergeReportValidation_inputMessage"/>
                            <variable name="MergeReportValidationRs"
                                      messageType="ns11:MergeReportValidation_outputMessage"/>
                        </variables>
                        <sequence name="sequenceForEachValidateInvoices">
                            <assign name="assignDownloadAttachmentRq">
                                <copy bpelx:insertMissingToData="yes" ignoreMissingFromData="yes">
                                    <from><literal><Element xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable"/></literal></from>
                                    <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varInvoiceAP</to>
                                </copy>
                                <copy bpelx:insertMissingToData="yes" ignoreMissingFromData="yes">
                                    <from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$inputVariable.payload/ns2:InvoicesAP/ns2:InvoiceAP[$counterInvoices]</from>
                                    <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varInvoiceAP</to>
                                </copy>
                                <copy bpelx:insertMissingToData="yes" ignoreMissingFromData="yes">
                                    <from>$varInvoiceAP/ns2:BusinessUnit</from>
                                    <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$invoikeWsERPIntegrationServiceTecDownloadAttachmentRq.DownloadAttachmentRq/ns1:Attachment/ns1:UserKeyA</to>
                                </copy>
                                <copy ignoreMissingFromData="yes" bpelx:insertMissingToData="yes">
                                    <from>$varInvoiceAP/ns2:InvoiceNumber</from>
                                    <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$invoikeWsERPIntegrationServiceTecDownloadAttachmentRq.DownloadAttachmentRq/ns1:Attachment/ns1:UserKeyB</to>
                                </copy>
                                <copy ignoreMissingFromData="yes" bpelx:insertMissingToData="yes">
                                    <from>$varInvoiceAP/ns2:SupplierNumber</from>
                                    <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$invoikeWsERPIntegrationServiceTecDownloadAttachmentRq.DownloadAttachmentRq/ns1:Attachment/ns1:UserKeyC</to>
                                </copy>
                                <copy ignoreMissingFromData="yes" bpelx:insertMissingToData="yes">
                                    <from>dvm:lookupValue("DVMs/dvmInvoicesBiz.dvm","Code","paramEntity","Value","","Component","ValidateInvoicesAP")</from>
                                    <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$invoikeWsERPIntegrationServiceTecDownloadAttachmentRq.DownloadAttachmentRq/ns1:Attachment/ns1:EntityName</to>
                                </copy>
                                <copy bpelx:insertMissingToData="yes" ignoreMissingFromData="yes">
                                    <from>dvm:lookupValue("DVMs/dvmInvoicesBiz.dvm","Code","paramCategoryName","Value","","Component","ValidateInvoicesAP")</from>
                                    <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$invoikeWsERPIntegrationServiceTecDownloadAttachmentRq.DownloadAttachmentRq/ns1:Attachment/ns1:CategoryName</to>
                                </copy>
                            </assign>
                            <if name="ifValidInvoice">
                                <documentation>
                                    <![CDATA[Continue]]>
                                </documentation>
                                <condition expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">string-length($varInvoiceAP/ns2:BusinessUnit) &gt;0 and string-length($varInvoiceAP/ns2:InvoiceNumber)&gt;0and string-length($varInvoiceAP/ns2:SupplierNumber)&gt;0</condition>
                                <sequence name="sequenceValidInvoice">
                                    <invoke name="invoikeWsERPIntegrationServiceTecDownloadAttachmentRq"
                                            inputVariable="invoikeWsERPIntegrationServiceTecDownloadAttachmentRq"
                                            outputVariable="invoikeWsERPIntegrationServiceTecDownloadAttachmentRs"
                                            partnerLink="wsERPIntegrationServiceTec"
                                            portType="ns1:ERPIntegrationTecPortType" operation="DownloadAttachment"
                                            bpelx:invokeAsDetail="no"/>
                                    <if name="IfExistAttachments">
                                        <documentation>
                                            <![CDATA[Continue]]>
                                        </documentation>
                                        <condition expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">string-length($invoikeWsERPIntegrationServiceTecDownloadAttachmentRs.DownloadAttachmentRs/ns1:Return/ns1:AttachmentContent) &gt;0</condition>
                                        <sequence name="sequenceDecodeBase64">
                                            <forEach parallel="no" counterName="counterAttachments"
                                                     name="forEachAttachments">
                                                <startCounterValue expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">1</startCounterValue>
                                                <finalCounterValue expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">count($invoikeWsERPIntegrationServiceTecDownloadAttachmentRs.DownloadAttachmentRs/ns1:Return)</finalCounterValue>
                                                <scope name="scopeAttachments">
                                                    <variables>
                                                        <variable name="varPayment" element="ns4:Payment"/>
                                                        <variable name="varXMLInvoice" element="ns8:Comprobante"/>
                                                        <variable name="varXMLInvoice40" element="ns18:Comprobante"/>
                                                    </variables>
                                                    <sequence name="sequenceAttachments">
                                                        <assign name="assignBase64">
                                                            <copy ignoreMissingFromData="yes"
                                                                  bpelx:insertMissingToData="yes">
                                                                <from>$invoikeWsERPIntegrationServiceTecDownloadAttachmentRs.DownloadAttachmentRs/ns1:Return[$counterAttachments]/ns1:AttachmentContent</from>
                                                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$invokeWsSOAUtilitiesTecDecodeRq.DecodeRq/ns3:charChain</to>
                                                            </copy>
                                                            <copy bpelx:insertMissingToData="yes">
                                                                <from>true()</from>
                                                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$invokeWsSOAUtilitiesTecDecodeRq.DecodeRq/ns3:contentStripping</to>
                                                            </copy>
                                                        </assign>
                                                        <invoke name="invokeWsSOAUtilitiesTecDecode"
                                                                partnerLink="wsSOAUtilitiesTec"
                                                                portType="ns3:SOAUtilitiesTecPortType"
                                                                operation="Decode"
                                                                inputVariable="invokeWsSOAUtilitiesTecDecodeRq"
                                                                outputVariable="invokeWsSOAUtilitiesTecDecodeRs"
                                                                bpelx:invokeAsDetail="no"/>
                                                        <if name="ifDecodedAttachment">
                                                            <documentation>
                                                                <![CDATA[ValidDecode]]>
                                                            </documentation>
                                                            <condition expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">string-length($invokeWsSOAUtilitiesTecDecodeRs.DecodeRs/ns3:Return/ns3:xmlOut) &gt; 0 </condition>
                                                            <sequence name="Sequence1">
                                                                <scope name="scopeParseXML">
                                                                    <faultHandlers>
                                                                        <catchAll>
                                                                            <empty name="empty"/>
                                                                        </catchAll>
                                                                    </faultHandlers>
                                                                    <sequence name="sequenceValidDecode">
                                                                        <assign name="assignParseXML4.0"
                                                                                xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable">
                                                                            <copy ignoreMissingFromData="yes"
                                                                                  bpelx:insertMissingToData="yes"
                                                                                  xmlns:bpelx="http://schemas.oracle.com/bpel/extension">
                                                                                <from>oraext:parseXML($invokeWsSOAUtilitiesTecDecodeRs.DecodeRs/ns3:Return/ns3:xmlOut)</from>
                                                                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varXMLInvoice40</to>
                                                                            </copy>
                                                                        </assign>
                                                                        <assign name="AssignMapCFDI40">
                                                                            <copy ignoreMissingFromData="yes"
                                                                                  bpelx:insertMissingToData="yes">
                                                                                <from>$varInvoiceAP/ns2:InvoiceNumber</from>
                                                                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varPayment/ns4:InvoiceNumber</to>
                                                                            </copy>
                                                                            <copy ignoreMissingFromData="yes"
                                                                                  bpelx:insertMissingToData="yes">
                                                                                <from>$varInvoiceAP/ns2:InvoiceId</from>
                                                                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varPayment/ns4:InvoiceId</to>
                                                                            </copy>
                                                                            <copy ignoreMissingFromData="yes"
                                                                                  bpelx:insertMissingToData="yes">
                                                                                <from>$varXMLInvoice40/ns18:Complemento/ns19:TimbreFiscalDigital/@UUID</from>
                                                                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varPayment/ns4:Uuid</to>
                                                                            </copy>
                                                                            <copy ignoreMissingFromData="yes"
                                                                                  bpelx:insertMissingToData="yes">
                                                                                <from>$varXMLInvoice40/ns18:Emisor/@Rfc</from>
                                                                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varPayment/ns4:RfcIssuer</to>
                                                                            </copy>
                                                                            <copy ignoreMissingFromData="yes"
                                                                                  bpelx:insertMissingToData="yes">
                                                                                <from>$varXMLInvoice40/ns18:Receptor/@Rfc</from>
                                                                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varPayment/ns4:RfcReceiver</to>
                                                                            </copy>
                                                                            <copy ignoreMissingFromData="yes"
                                                                                  bpelx:insertMissingToData="yes">
                                                                                <from>$varXMLInvoice40/@Total</from>
                                                                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varPayment/ns4:TotalAmount</to>
                                                                            </copy>
                                                                            <copy ignoreMissingFromData="yes"
                                                                                  bpelx:insertMissingToData="yes">
                                                                                <from>$varXMLInvoice40/ns18:Conceptos/ns18:Concepto[1]/ns18:CuentaPredial[1]/@Numero</from>
                                                                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varPayment/ns4:CuentaPredial</to>
                                                                            </copy>
                                                                            <copy ignoreMissingFromData="yes"
                                                                                  bpelx:insertMissingToData="yes">
                                                                                <from>$varXMLInvoice40/ns18:Receptor/@UsoCFDI</from>
                                                                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varPayment/ns4:UsoCFDI</to>
                                                                            </copy>
                                                                            <copy ignoreMissingFromData="yes"
                                                                                  bpelx:insertMissingToData="yes">
                                                                                <from>$varXMLInvoice40/@Moneda</from>
                                                                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varPayment/ns4:Moneda</to>
                                                                            </copy>
                                                                            <copy ignoreMissingFromData="yes"
                                                                                  bpelx:insertMissingToData="yes">
                                                                                <from>$varXMLInvoice40/ns18:Conceptos/ns18:Concepto[1]/ns18:InformacionAduanera[1]/@NumeroPedimento</from>
                                                                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varPayment/ns4:InformacionAduanera</to>
                                                                            </copy>
                                                                            <copy ignoreMissingFromData="yes"
                                                                                  bpelx:insertMissingToData="yes">
                                                                                <from>$varXMLInvoice40/@FormaPago</from>
                                                                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varPayment/ns4:FormaPago</to>
                                                                            </copy>
                                                                            <copy ignoreMissingFromData="yes"
                                                                                  bpelx:insertMissingToData="yes">
                                                                                <from>$varXMLInvoice40/@MetodoPago</from>
                                                                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varPayment/ns4:MetodoPago</to>
                                                                            </copy>
                                                                            <copy ignoreMissingFromData="yes"
                                                                                  bpelx:insertMissingToData="yes">
                                                                                <from>$varXMLInvoice40/ns18:Conceptos/ns18:Concepto[1]/@ClaveProdServ</from>
                                                                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varPayment/ns4:ClaveProdServ</to>
                                                                            </copy>
                                                                            <copy ignoreMissingFromData="yes"
                                                                                  bpelx:insertMissingToData="yes">
                                                                                <from>$varXMLInvoice40/ns18:Complemento/ns19:TimbreFiscalDigital/@FechaTimbrado</from>
                                                                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varPayment/ns4:FechaTimbrado</to>
                                                                            </copy>
                                                                            <copy ignoreMissingFromData="yes"
                                                                                  bpelx:insertMissingToData="yes">
                                                                                <from>$varXMLInvoice40/@TipoDeComprobante</from>
                                                                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varPayment/ns4:TipoDeComprobante</to>
                                                                            </copy>
                                                                            <copy ignoreMissingFromData="yes"
                                                                                  bpelx:insertMissingToData="yes">
                                                                                <from>$varXMLInvoice40/@SubTotal</from>
                                                                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varPayment/ns4:SubTotal</to>
                                                                            </copy>
                                                                            <copy ignoreMissingFromData="yes"
                                                                                  bpelx:insertMissingToData="yes">
                                                                                <from>$varXMLInvoice40/ns18:CfdiRelacionados/@TipoRelacion</from>
                                                                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varPayment/ns4:TipoRelacion</to>
                                                                            </copy>
                                                                            <copy ignoreMissingFromData="yes"
                                                                                  bpelx:insertMissingToData="yes">
                                                                                <from>$varXMLInvoice40/ns18:CfdiRelacionados[1]/ns18:CfdiRelacionado[1]/@UUID</from>
                                                                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varPayment/ns4:UUIDRelacion</to>
                                                                            </copy>
                                                                            <copy ignoreMissingFromData="yes"
                                                                                  bpelx:insertMissingToData="yes">
                                                                                <from>$varXMLInvoice40/ns18:Emisor/@Rfc</from>
                                                                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varPayment/ns4:RFCEmisor</to>
                                                                            </copy>
                                                                            <copy ignoreMissingFromData="yes"
                                                                                  bpelx:insertMissingToData="yes">
                                                                                <from>$varXMLInvoice40/ns18:Emisor/@Nombre</from>
                                                                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varPayment/ns4:NomEmisor</to>
                                                                            </copy>
                                                                            <copy ignoreMissingFromData="yes"
                                                                                  bpelx:insertMissingToData="yes">
                                                                                <from>$varXMLInvoice40/@Descuento</from>
                                                                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varPayment/ns4:Descuento</to>
                                                                            </copy>
                                                                            <copy ignoreMissingFromData="yes"
                                                                                  bpelx:insertMissingToData="yes">
                                                                                <from>$varXMLInvoice40/@TipoCambio</from>
                                                                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varPayment/ns4:TipoCambio</to>
                                                                            </copy>
                                                                            <copy ignoreMissingFromData="yes"
                                                                                  bpelx:insertMissingToData="yes">
                                                                                <from>$varXMLInvoice40/ns18:Conceptos/ns18:Concepto[1]/@Descripcion</from>
                                                                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varPayment/ns4:DescripcionL</to>
                                                                            </copy>
                                                                            <copy ignoreMissingFromData="yes"
                                                                                  bpelx:insertMissingToData="yes">
                                                                                <from>$varXMLInvoice40/ns18:Impuestos/ns18:Retenciones/ns18:Retencion[1]/@Importe</from>
                                                                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varPayment/ns4:RetenidoIVA</to>
                                                                            </copy>
                                                                            <copy ignoreMissingFromData="yes"
                                                                                  bpelx:insertMissingToData="yes">
                                                                                <from>$varXMLInvoice40/ns18:Impuestos/ns18:Traslados/ns18:Traslado[1]/@Importe</from>
                                                                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varPayment/ns4:RetenidoISR</to>
                                                                            </copy>
                                                                            <copy ignoreMissingFromData="yes"
                                                                                  bpelx:insertMissingToData="yes">
                                                                                <from>$varXMLInvoice40/ns18:Impuestos/ns18:Traslados/ns18:Traslado/@TasaOCuota</from>
                                                                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varPayment/ns4:Impuesto</to>
                                                                            </copy>
                                                                            <copy ignoreMissingFromData="yes"
                                                                                  bpelx:insertMissingToData="yes">
                                                                                <from>$varXMLInvoice40/ns18:Conceptos/ns18:Concepto[1]/ns18:Impuestos/ns18:Traslados/ns18:Traslado[1]/@TasaOCuota</from>
                                                                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varPayment/ns4:Importe</to>
                                                                            </copy>
                                                                            <copy ignoreMissingFromData="yes"
                                                                                  bpelx:insertMissingToData="yes">
                                                                                <from>$varXMLInvoice40/ns18:Conceptos/ns18:Concepto[1]/ns18:Impuestos/ns18:Traslados/ns18:Traslado[1]/@Impuesto</from>
                                                                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varPayment/ns4:Impuestoieps</to>
                                                                            </copy>
                                                                            <copy ignoreMissingFromData="yes"
                                                                                  bpelx:insertMissingToData="yes">
                                                                                <from>$varXMLInvoice40/ns18:Conceptos/ns18:Concepto[1]/ns18:Impuestos/ns18:Traslados/ns18:Traslado[1]/@Importe</from>
                                                                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varPayment/ns4:Importeieps</to>
                                                                            </copy>
                                                                        </assign>
                                                                        <if name="If_parse3.3Valido">
                                                                            <documentation>
                                                                                <![CDATA[If_parse4.0]]>
                                                                            </documentation>
                                                                            <condition>string-length($varPayment/ns4:Uuid)=0</condition><sequence name="Sequence8">
                                                                                <assign name="assignParseXML">
                                                                                    <copy ignoreMissingFromData="yes"
                                                                                          bpelx:insertMissingToData="yes">
                                                                                        <from>oraext:parseXML($invokeWsSOAUtilitiesTecDecodeRs.DecodeRs/ns3:Return/ns3:xmlOut)</from>
                                                                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varXMLInvoice</to>
                                                                                    </copy>
                                                                                </assign>
                                                                                <assign name="trCurrentInvoiceAP_To_VarInvoiceDataRq">
                                                                                    <bpelx:annotation>
                                                                                        <bpelx:pattern patternName="bpelx:transformation"></bpelx:pattern>
                                                                                    </bpelx:annotation>
                                                                                    <copy>
                                                                                        <from>ora:doXSLTransformForDoc("../Transformations/XSLs/trCurrentInvoiceAP_To_VarInvoiceDataRq.xsl", $varInvoiceAP, "varXMLInvoice", $varXMLInvoice)</from>
                                                                                        <to variable="varPayment"/>
                                                                                    </copy>
                                                                                </assign>
                                                                            </sequence></if>
                                                                        <assign name="assignCurrentInvoiceData"
                                                                                xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable">
                                                                            <copy ignoreMissingFromData="yes"
                                                                                  bpelx:insertMissingToData="yes">
                                                                                <from>$varPayment</from>
                                                                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varValidatePaymentRq/ns4:Payment</to>
                                                                            </copy>
                                                                        </assign>
                                                                        <assign name="TrValidationAuto">
                                                                            <bpelx:annotation>
                                                                                <bpelx:pattern patternName="bpelx:transformation"></bpelx:pattern>
                                                                            </bpelx:annotation>
                                                                            <copy>
                                                                                <from>ora:doXSLTransformForDoc("../Transformations/trWsValidationAutomaticaTecMepearOracleXml_1.xsl", $varInvoiceAP, "invokeWsSOAUtilitiesTecDecodeRq.DecodeRq", $invokeWsSOAUtilitiesTecDecodeRq.DecodeRq)</from>
                                                                                <to variable="InvokeValidatiAutomIntPut"
                                                                                    part="request"/>
                                                                            </copy>
                                                                        </assign>
                                                                        <if name="If_ArrendamientoF"
                                                                            xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable">
                                                                            <documentation>
                                                                                <![CDATA[ARREf]]>
                                                                            </documentation>
                                                                            <condition>$inputVariable.payload/ns2:InvoicesAP/ns2:InvoiceAP[1]/ns2:details[ns2:gccSegment5='6211' and ns2:idLineType='ITEM']</condition>
                                                                            <scope name="Scope1">
                                                                                <variables>
                                                                                    <variable name="v_restar"
                                                                                              type="xsd:decimal">
                                                                                        <from>0</from>
                                                                                    </variable>
                                                                                </variables>
                                                                                <sequence>
                                                                                    <if name="If_RetNotNull">
                                                                                        <documentation>
                                                                                            <![CDATA[not
Null]]>
                                                                                        </documentation>
                                                                                        <condition>string-length($inputVariable.payload/ns2:InvoicesAP/ns2:InvoiceAP[1]/ns2:SupplierSiteAwtPercentageRate)&gt;0</condition>
                                                                                        <if name="If_mass0">
                                                                                            <condition>$inputVariable.payload/ns2:InvoicesAP/ns2:InvoiceAP[1]/ns2:SupplierSiteAwtPercentageRate&gt;0</condition>
                                                                                            <assign name="Assign3">
                                                                                                <copy>
                                                                                                    <from>.10</from>
                                                                                                    <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$v_restar</to>
                                                                                                </copy>
                                                                                            </assign>
                                                                                        </if>
                                                                                    </if>
                                                                                    <assign name="AssignValorGrupo">
                                                                                        <copy>
                                                                                            <from>$inputVariable.payload/ns2:InvoicesAP/ns2:InvoiceAP/ns2:InvoiceAwtPercentageRate - $v_restar</from>
                                                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$InvokeValidatiAutomIntPut.request/ns11:invoiceAwtPercentageRate</to>
                                                                                        </copy>
                                                                                        <copy>
                                                                                            <from>$inputVariable.payload/ns2:InvoicesAP/ns2:InvoiceAP/ns2:SupplierSiteAwtPercentageRate - $v_restar</from>
                                                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$InvokeValidatiAutomIntPut.request/ns11:supplier/ns11:siteAwtPercentageRate</to>
                                                                                        </copy>
                                                                                    </assign>
                                                                                    <forEach parallel="no"
                                                                                             counterName="counterOrderlines"
                                                                                             name="For_linesOrder">
                                                                                        <startCounterValue>1</startCounterValue>
                                                                                        <finalCounterValue>count($InvokeValidatiAutomIntPut.request/ns11:details)</finalCounterValue>
                                                                                        <scope name="Scopeorderlines">
                                                                                            <if name="If_Linea">
                                                                                                <documentation>
                                                                                                    <![CDATA[Item]]>
                                                                                                </documentation>
                                                                                                <condition>$InvokeValidatiAutomIntPut.request/ns11:details[$counterOrderlines]/ns11:orderDetail/ns11:codeCombination/ns11:segment5='6211' and $InvokeValidatiAutomIntPut.request/ns11:details/ns11:lineType='ITEM'</condition>
                                                                                                <assign name="AssignValorGrupo"
                                                                                                        xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable">
                                                                                                    <copy ignoreMissingFromData="yes">
                                                                                                        <from>$inputVariable.payload/ns2:InvoicesAP/ns2:InvoiceAP[1]/ns2:details[ns2:gccSegment5='6211' and ns2:idLineType='ITEM']/ns2:awtPercentageRate - $v_restar</from>
                                                                                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$InvokeValidatiAutomIntPut.request/ns11:details[$counterOrderlines]/ns11:awtPercentageRate</to>
                                                                                                    </copy>
                                                                                                </assign>
                                                                                            </if>
                                                                                        </scope>
                                                                                    </forEach>
                                                                                </sequence>
                                                                            </scope>
                                                                        </if>
                                                                        <scope name="ScopeUUID_Unico"
                                                                               xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable">
                                                                            <variables>
                                                                                <variable name="GetReportValidationRq"
                                                                                          messageType="ns11:GetReportValidation_inputMessage"/>
                                                                                <variable name="GetReportValidationRs"
                                                                                          messageType="ns11:GetReportValidation_outputMessage"/>
                                                                            </variables>
                                                                            <sequence name="SequenceUUID_Unico"><assign name="getReportValidation">
                                                                                    <copy ignoreMissingFromData="yes">
                                                                                        <from>xp20:upper-case($varValidatePaymentRq/ns4:Payment[1]/ns4:Uuid)</from>
                                                                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$GetReportValidationRq.request/ns11:uuid</to>
                                                                                    </copy>
                                                                                    <copy>
                                                                                        <from>'VALIDADO'</from>
                                                                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$GetReportValidationRq.request/ns11:status</to>
                                                                                    </copy>
                                                                                </assign>
                                                                                <invoke name="getUUID"
                                                                                        partnerLink="ValidationAutomatTec"
                                                                                        portType="ns11:ERPValidacionConsultBS_ptt"
                                                                                        operation="GetReportValidation"
                                                                                        inputVariable="GetReportValidationRq"
                                                                                        outputVariable="GetReportValidationRs"
                                                                                        xmlns:bpelx="http://schemas.oracle.com/bpel/extension"
                                                                                        bpelx:invokeAsDetail="no"/>
                                                                                <if name="If_MoreOneFolio"
                                                                                    xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable">
      <documentation>
         <![CDATA[Duplicado mas de un folio]]>
      </documentation>
      <condition>count($GetReportValidationRs.request/ns11:XxerInvoicesApTbl)&gt;1</condition>
      <assign name="AssignFolio" xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable">
         <copy>
            <from>'DUPLICADO'</from>
            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$InvokeValidatiAutomIntPut.request/ns11:folio</to>
         </copy>
      </assign>
      <elseif>
         <documentation>
            <![CDATA[UnFolio]]>
         </documentation>
         <condition>count($GetReportValidationRs.request/ns11:XxerInvoicesApTbl)=1</condition>
         <if name="If_EsIgual">
            <documentation>
               <![CDATA[FolioIgual]]>
            </documentation>
            <condition>$GetReportValidationRs.request/ns11:XxerInvoicesApTbl[1]/ns11:invoiceNumber =$inputVariable.payload/ns2:InvoicesAP/ns2:InvoiceAP[1]/ns2:InvoiceNumber</condition>
            <assign name="AssignFolio" xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable">
               <copy>
                  <from>'UNICO'</from>
                  <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$InvokeValidatiAutomIntPut.request/ns11:folio</to>
               </copy>
            </assign>
            <else>
               <documentation>
                  <![CDATA[FolioDiferente]]>
               </documentation>
               <assign name="AssignFolio">
                                                                                                    <copy>
                                                                                                        <from>'DUPLICADO'</from>
                                                                                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$InvokeValidatiAutomIntPut.request/ns11:folio</to>
                                                                                                    </copy>
                                                                                                </assign>
            </else>
         </if>
      </elseif>
      <else>
         <documentation>
            <![CDATA[NoHayFolio]]>
         </documentation>
         <assign name="AssignFolio" xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable">
            <copy>
               <from>'UNICO'</from>
               <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$InvokeValidatiAutomIntPut.request/ns11:folio</to>
            </copy>
         </assign>
      </else>
   </if>
                                                                            </sequence>
                                                                        </scope>
                                                                        <invoke name="InvokeValidatiAutom"
                                                                                partnerLink="ValidationAutomatTec"
                                                                                portType="ns10:ERPValidacionConsultBS_ptt"
                                                                                operation="ValidaOracleXml"
                                                                                inputVariable="InvokeValidatiAutomIntPut"
                                                                                outputVariable="InvokeValidatiAutomOutPut"
                                                                                bpelx:invokeAsDetail="no"/>
                                                                        <if name="If_SendEmailValidation">
                                                                            <documentation>
                                                                                <![CDATA[notifaction]]>
                                                                            </documentation>
                                                                            <condition>count($InvokeValidatiAutomOutPut.request/ns11:invoiceId)&gt;0</condition>
                                                                            <extensionActivity>
                                                                                <bpelx:call name="SendNotifacation"
                                                                                            xmlns:sp1="http://soa.estrellaroja.com.mx/InvoicesBiz/sbpelSenNotificationValidation"
                                                                                            target="sp1:sbpelSenNotificationValidation">
                                                                                    <bpelx:param name="v_ValidationRs"
                                                                                                 copyByValue="yes"
                                                                                                 variable="InvokeValidatiAutomOutPut"/>
                                                                                    <bpelx:param name="varInvoiceAP"
                                                                                                 copyByValue="yes"
                                                                                                 variable="varInvoiceAP"/>
                                                                                    <bpelx:param name="varUUID"
                                                                                                 copyByValue="yes">$varValidatePaymentRq/ns4:Payment/ns4:Uuid</bpelx:param>
                                                                                </bpelx:call>
                                                                            </extensionActivity>
                                                                        </if>
                                                                        <if name="ifValidationAutomat">
                                                                            <documentation>
                                                                                <![CDATA[ValidaFactura]]>
                                                                            </documentation>
                                                                            <condition expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$InvokeValidatiAutomOutPut.request/ns11:success = 'true'</condition>
                                                                            <sequence name="SeqValidar">
                                                                                <bpelx:skipCondition>$v_pruebas</bpelx:skipCondition>
                                                                                <if name="If_generaDistribuciones">
                                                                                    <condition>dvm:lookupValue("DVMs/dvmInvoicesBiz.dvm","Code","generarDistribuciones","Value","","Component","ValidateInvoicesAP")='true'</condition>
                                                                                    <sequence name="Sequence5">
                                                                                        <assign name="Assign1">
                                                                                            <copy>
                                                                                                <from>'generateDistributions'</from>
                                                                                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$wsERPintegrationApiTec_postInvoiceRq.request/name</to>
                                                                                            </copy>
                                                                                            <copy>
                                                                                                <from>'VALIDADO'</from>
                                                                                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:status</to>
                                                                                            </copy>
                                                                                            <copy>
                                                                                                <from>$InvokeValidatiAutomIntPut.request/ns11:number</from>
                                                                                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$wsERPintegrationApiTec_postInvoiceRq.request/parameters/InvoiceNumber</to>
                                                                                            </copy>
                                                                                            <copy>
                                                                                                <from>$InvokeValidatiAutomIntPut.request/ns11:businessUnit</from>
                                                                                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$wsERPintegrationApiTec_postInvoiceRq.request/parameters/BusinessUnit</to>
                                                                                            </copy>
                                                                                            <copy>
                                                                                                <from>$InvokeValidatiAutomIntPut.request/ns11:supplier/ns11:name</from>
                                                                                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$wsERPintegrationApiTec_postInvoiceRq.request/parameters/Supplier</to>
                                                                                            </copy>
                                                                                        </assign>
                                                                                        <invoke name="wsERPintegrationApiTec"
                                                                                                partnerLink="wsERPIntegrationApiTec"
                                                                                                portType="ns17:postInvoicePortType"
                                                                                                operation="postInvoice"
                                                                                                inputVariable="wsERPintegrationApiTec_postInvoiceRq"
                                                                                                outputVariable="wsERPintegrationApiTec_postInvoiceRs"
                                                                                                bpelx:invokeAsDetail="no"/>
                                                                                    </sequence>
                                                                                </if>
                                                                                <if name="If_generarImpuestos">
                                                                                    <condition>dvm:lookupValue("DVMs/dvmInvoicesBiz.dvm","Code","calcularImpuestos","Value","","Component","ValidateInvoicesAP")='true'</condition>
                                                                                    <sequence name="Sequence6">
                                                                                        <assign name="Assign2">
                                                                                            <copy>
                                                                                                <from>'calculateTax'</from>
                                                                                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$wsERPintegrationApiTec_postInvoiceRq.request/name</to>
                                                                                            </copy>
                                                                                        </assign>
                                                                                        <invoke name="wsErpIntegrationApiTec"
                                                                                                partnerLink="wsERPIntegrationApiTec"
                                                                                                portType="ns17:postInvoicePortType"
                                                                                                operation="postInvoice"
                                                                                                inputVariable="wsERPintegrationApiTec_postInvoiceRq"
                                                                                                outputVariable="wsERPintegrationApiTec_postInvoiceRs"
                                                                                                bpelx:invokeAsDetail="no"/>
                                                                                    </sequence>
                                                                                </if>
                                                                                <assign name="TrValidationInvoice">
                                                                                    <bpelx:annotation>
                                                                                        <bpelx:pattern patternName="bpelx:transformation"></bpelx:pattern>
                                                                                    </bpelx:annotation>
                                                                                    <copy>
                                                                                        <from>ora:doXSLTransformForDoc("../Transformations/TransformationValidationAutomaticaERPCloud_1.xsl", $varInvoiceAP)</from>
                                                                                        <to variable="submitIntPut"
                                                                                            part="parameters"/>
                                                                                    </copy>
                                                                                </assign>
                                                                                <invoke name="InvValidateInvoiceAP"
                                                                                        bpelx:invokeAsDetail="no"
                                                                                        partnerLink="wsErpIntegrationServicevA"
                                                                                        portType="ns12:ErpIntegrationService"
                                                                                        operation="submitESSJobRequest"
                                                                                        inputVariable="submitIntPut"
                                                                                        outputVariable="submitOutPut"/>
                                                                            </sequence>
                                                                            <elseif>
                                                                                <documentation>
                                                                                    <![CDATA[RetieneFactura]]>
                                                                                </documentation>
                                                                                <condition expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$InvokeValidatiAutomOutPut.request/ns11:mustModify = 'true'</condition>
                                                                                <sequence name="Sequence3">
                                                                                    <bpelx:skipCondition>$v_pruebas</bpelx:skipCondition>
                                                                                    <assign name="AsRetecionInvoice">
                                                                                        <copy>
                                                                                            <from>$InvokeValidatiAutomOutPut.request/ns11:oracleLookupCode</from>
                                                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$RetieneFacInt.parameters/ns14:releaseLookupCode</to>
                                                                                        </copy>
                                                                                        <copy>
                                                                                            <from>'RETENIDO'</from>
                                                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:status</to>
                                                                                        </copy>
                                                                                        <copy>
                                                                                            <from>$InvokeValidatiAutomOutPut.request/ns11:oracleLookupCode</from>
                                                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$RetieneFacInt.parameters/ns14:holdLookupCode</to>
                                                                                        </copy>
                                                                                        <copy>
                                                                                            <from>''</from>
                                                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$RetieneFacInt.parameters/ns14:voucherNumber</to>
                                                                                        </copy>
                                                                                        <copy>
                                                                                            <from>$varInvoiceAP/ns2:BusinessUnit</from>
                                                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$RetieneFacInt.parameters/ns14:businessUnitName</to>
                                                                                        </copy>
                                                                                        <copy>
                                                                                            <from>$varInvoiceAP/ns2:SupplierName</from>
                                                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$RetieneFacInt.parameters/ns14:supplierName</to>
                                                                                        </copy>
                                                                                        <copy>
                                                                                            <from>$varInvoiceAP/ns2:SupplierNumber</from>
                                                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$RetieneFacInt.parameters/ns14:supplierNumber</to>
                                                                                        </copy>
                                                                                        <copy>
                                                                                            <from>$varInvoiceAP/ns2:InvoiceNumber</from>
                                                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$RetieneFacInt.parameters/ns14:invoiceNumber</to>
                                                                                        </copy>
                                                                                    </assign>
                                                                                    <invoke name="RetieneFacturaAP"
                                                                                            partnerLink="wsInvoiceServiceCr"
                                                                                            portType="ns13:InvoiceService"
                                                                                            operation="releaseSingleHold"
                                                                                            inputVariable="RetieneFacInt"
                                                                                            outputVariable="RetieneFacOut"
                                                                                            bpelx:invokeAsDetail="no"/>
                                                                                </sequence>
                                                                            </elseif>
                                                                            <elseif>
                                                                                <documentation>
                                                                                    <![CDATA[CancelaFactura]]>
                                                                                </documentation>
                                                                                <condition expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$InvokeValidatiAutomOutPut.request/ns11:mustCancel = 'true'</condition>
                                                                                <sequence name="Sequence4">
                                                                                    <bpelx:skipCondition>$v_pruebas</bpelx:skipCondition>
                                                                                    <extensionActivity xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable">
                                                                                        <bpelx:call name="callSBpelReleaseInvoicesAP"
                                                                                                    xmlns:sp1="http://soa.estrellaroja.com.mx/InvoicesBiz/sbpelReleaseInvoicesAP"
                                                                                                    target="sp1:sbpelReleaseInvoicesAP"
                                                                                                    xmlns:bpelx="http://schemas.oracle.com/bpel/extension">
                                                                                            <bpelx:param name="varReleaseInvoicesAP"
                                                                                                         copyByValue="yes">$inputVariable.payload</bpelx:param>
                                                                                        </bpelx:call>
                                                                                    </extensionActivity>
                                                                                    <assign name="AsCancelValidatinERP">
                                                                                        <copy>
                                                                                            <from>$varInvoiceAP/ns2:BusinessUnit</from>
                                                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$CancelInvoiceInt.parameters/ns14:businessUnitName</to>
                                                                                        </copy>
                                                                                        <copy>
                                                                                            <from>'CANCELADO'</from>
                                                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:status</to>
                                                                                        </copy>
                                                                                        <copy>
                                                                                            <from>$varInvoiceAP/ns2:SupplierName</from>
                                                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$CancelInvoiceInt.parameters/ns14:supplierName</to>
                                                                                        </copy>
                                                                                        <copy>
                                                                                            <from>$varInvoiceAP/ns2:SupplierNumber</from>
                                                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$CancelInvoiceInt.parameters/ns14:supplierNumber</to>
                                                                                        </copy>
                                                                                        <copy>
                                                                                            <from>$varInvoiceAP/ns2:InvoiceNumber</from>
                                                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$CancelInvoiceInt.parameters/ns14:invoiceNumber</to>
                                                                                        </copy>
                                                                                        <copy>
                                                                                            <from>''</from>
                                                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$CancelInvoiceInt.parameters/ns14:voucherNumber</to>
                                                                                        </copy>
                                                                                    </assign>
                                                                                    <invoke name="CancelarFacturaAP"
                                                                                            partnerLink="wsInvoiceServiceCr"
                                                                                            portType="ns13:InvoiceService"
                                                                                            operation="cancelInvoice"
                                                                                            inputVariable="CancelInvoiceInt"
                                                                                            outputVariable="CancelInvoiceOut"
                                                                                            bpelx:invokeAsDetail="no"/>
                                                                                </sequence>
                                                                            </elseif>
                                                                            <else>
                                                                                <empty name="EmptyValidationAutom"/>
                                                                            </else>
                                                                        </if>
                                                                        <scope name="ScopeMergeTP">
                                                                            <sequence name="SequenceMergeTP">
                                                                                <assign name="InsertaValidation">
                                                                                    <copy ignoreMissingFromData="yes">
                                                                                        <from>xp20:current-dateTime()</from>
                                                                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:creationDate</to>
                                                                                    </copy>
                                                                                    <copy ignoreMissingFromData="yes">
                                                                                        <from>concat($varInvoiceAP/ns2:InvoiceAwtGroupCode,'-',$varInvoiceAP/ns2:InvoiceAwtPercentageRate)</from>
                                                                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:ish</to>
                                                                                    </copy>
                                                                                    <copy ignoreMissingFromData="yes">
                                                                                        <from>$InvokeValidatiAutomOutPut.request/ns11:message</from>
                                                                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:estatusValidacionDesc</to>
                                                                                    </copy>
                                                                                    <copy ignoreMissingFromData="yes">
                                                                                        <from>$InvokeValidatiAutomOutPut.request/ns11:success</from>
                                                                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:estatusValidacion</to>
                                                                                    </copy>
                                                                                    <copy ignoreMissingFromData="yes">
                                                                                        <from>$varInvoiceAP/ns2:Total</from>
                                                                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:attribute2</to>
                                                                                    </copy>
                                                                                    <copy ignoreMissingFromData="yes">
                                                                                        <from>$varValidatePaymentRq/ns4:Payment[1]/ns4:RetenidoISR</from>
                                                                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:retenidoIsr</to>
                                                                                    </copy>
                                                                                    <copy ignoreMissingFromData="yes">
                                                                                        <from>$varValidatePaymentRq/ns4:Payment[1]/ns4:RetenidoIVA</from>
                                                                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:retenidoIva</to>
                                                                                    </copy>
                                                                                    <copy ignoreMissingFromData="yes">
                                                                                        <from>$varValidatePaymentRq/ns4:Payment[1]/ns4:Importe</from>
                                                                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:iva8</to>
                                                                                    </copy>
                                                                                    <copy ignoreMissingFromData="yes">
                                                                                        <from>$varValidatePaymentRq/ns4:Payment/ns4:TotalAmount</from>
                                                                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:total</to>
                                                                                    </copy>
                                                                                    <copy ignoreMissingFromData="yes">
                                                                                        <from>$varValidatePaymentRq/ns4:Payment[1]/ns4:Importeieps</from>
                                                                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:combustible</to>
                                                                                    </copy>
                                                                                    <copy ignoreMissingFromData="yes">
                                                                                        <from>$varValidatePaymentRq/ns4:Payment[1]/ns4:Impuestoieps</from>
                                                                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:totalIeps</to>
                                                                                    </copy>
                                                                                    <copy ignoreMissingFromData="yes">
                                                                                        <from>$varValidatePaymentRq/ns4:Payment[1]/ns4:Impuesto</from>
                                                                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:iva16</to>
                                                                                    </copy>
                                                                                    <copy ignoreMissingFromData="yes">
                                                                                        <from>$varInvoiceAP/ns2:InvoiceId</from>
                                                                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:invoiceId</to>
                                                                                    </copy>
                                                                                    <copy ignoreMissingFromData="yes">
                                                                                        <from>$varInvoiceAP/ns2:BusinessUnit</from>
                                                                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:businessUnit</to>
                                                                                    </copy>
                                                                                    <copy ignoreMissingFromData="yes">
                                                                                        <from>$varInvoiceAP/ns2:BusinessUnit</from>
                                                                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:unidadNegocio</to>
                                                                                    </copy>
                                                                                    <copy ignoreMissingFromData="yes">
                                                                                        <from>$varInvoiceAP/ns2:SupplierName</from>
                                                                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:attribute5</to>
                                                                                    </copy>
                                                                                    <copy ignoreMissingFromData="yes">
                                                                                        <from>$varInvoiceAP/ns2:CreationDate</from>
                                                                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:attribute4</to>
                                                                                    </copy>
                                                                                    <copy ignoreMissingFromData="yes">
                                                                                        <from>$varValidatePaymentRq/ns4:Payment[1]/ns4:InformacionAduanera</from>
                                                                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:attribute3</to>
                                                                                    </copy>
                                                                                    <copy ignoreMissingFromData="yes">
                                                                                        <from>$varValidatePaymentRq/ns4:Payment[1]/ns4:RFCEmisor</from>
                                                                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:attribute1</to>
                                                                                    </copy>
                                                                                    <copy ignoreMissingFromData="yes">
                                                                                        <from>$varInvoiceAP/ns2:InvoiceNumber</from>
                                                                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:invoiceNumber</to>
                                                                                    </copy>
                                                                                    <copy ignoreMissingFromData="yes">
                                                                                        <from>$varInvoiceAP/ns2:SupplierNumber</from>
                                                                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:supplierNumber</to>
                                                                                    </copy>
                                                                                    <copy ignoreMissingFromData="yes">
                                                                                        <from>$varInvoiceAP/ns2:SupplierSiteCode</from>
                                                                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:sitioProveedor</to>
                                                                                    </copy>
                                                                                    <copy ignoreMissingFromData="yes">
                                                                                        <from>$varInvoiceAP/ns2:details[1]/ns2:gccSegment3</from>
                                                                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:tercerSegmCotable</to>
                                                                                    </copy>
                                                                                    <copy ignoreMissingFromData="yes">
                                                                                        <from>$varInvoiceAP/ns2:details[1]/ns2:gccSegment5</from>
                                                                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:quintoSegmContable</to>
                                                                                    </copy>
                                                                                    <copy ignoreMissingFromData="yes">
                                                                                        <from>$varInvoiceAP/ns2:SupplierName</from>
                                                                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:nombreEmisor</to>
                                                                                    </copy>
                                                                                    <copy ignoreMissingFromData="yes">
                                                                                        <from>$varValidatePaymentRq/ns4:Payment[1]/ns4:SubTotal</from>
                                                                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:subtotal</to>
                                                                                    </copy>
                                                                                    <copy ignoreMissingFromData="yes">
                                                                                        <from>$varValidatePaymentRq/ns4:Payment[1]/ns4:DescripcionL</from>
                                                                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:conceptos</to>
                                                                                    </copy>
                                                                                    <copy ignoreMissingFromData="yes">
                                                                                        <from>$varValidatePaymentRq/ns4:Payment[1]/ns4:Moneda</from>
                                                                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:moneda</to>
                                                                                    </copy>
                                                                                    <copy ignoreMissingFromData="yes">
                                                                                        <from>$varValidatePaymentRq/ns4:Payment[1]/ns4:TotalAmount</from>
                                                                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:amount</to>
                                                                                    </copy>
                                                                                    <copy ignoreMissingFromData="yes">
                                                                                        <from>$varValidatePaymentRq/ns4:Payment[1]/ns4:CuentaPredial</from>
                                                                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:lastUpdatedBy</to>
                                                                                    </copy>
                                                                                    <copy ignoreMissingFromData="yes">
                                                                                        <from>$varValidatePaymentRq/ns4:Payment[1]/ns4:TipoDeComprobante</from>
                                                                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:tipoComprobante</to>
                                                                                    </copy>
                                                                                    <copy ignoreMissingFromData="yes">
                                                                                        <from>$varValidatePaymentRq/ns4:Payment[1]/ns4:FechaTimbrado</from>
                                                                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:fechaTimbrado</to>
                                                                                    </copy>
                                                                                    <copy ignoreMissingFromData="yes">
                                                                                        <from>$varValidatePaymentRq/ns4:Payment[1]/ns4:TipoRelacion</from>
                                                                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:tipoRelacion</to>
                                                                                    </copy>
                                                                                    <copy ignoreMissingFromData="yes">
                                                                                        <from>$varValidatePaymentRq/ns4:Payment[1]/ns4:UUIDRelacion</from>
                                                                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:uuidRelacion</to>
                                                                                    </copy>
                                                                                    <copy ignoreMissingFromData="yes">
                                                                                        <from>$varValidatePaymentRq/ns4:Payment[1]/ns4:Descuento</from>
                                                                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:descuento</to>
                                                                                    </copy>
                                                                                    <copy ignoreMissingFromData="yes">
                                                                                        <from>$varValidatePaymentRq/ns4:Payment[1]/ns4:TipoCambio</from>
                                                                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:tipoCambio</to>
                                                                                    </copy>
                                                                                    <copy ignoreMissingFromData="yes">
                                                                                        <from>$varValidatePaymentRq/ns4:Payment[1]/ns4:MetodoPago</from>
                                                                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:metodoPago</to>
                                                                                    </copy>
                                                                                    <copy ignoreMissingFromData="yes">
                                                                                        <from>$varValidatePaymentRq/ns4:Payment[1]/ns4:FormaPago</from>
                                                                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:formaPago</to>
                                                                                    </copy>
                                                                                    <copy ignoreMissingFromData="yes">
                                                                                        <from>$varValidatePaymentRq/ns4:Payment[1]/ns4:UsoCFDI</from>
                                                                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:usoCfdi</to>
                                                                                    </copy>
                                                                                    <copy ignoreMissingFromData="yes">
                                                                                        <from>$varValidatePaymentRq/ns4:Payment[1]/ns4:Uuid</from>
                                                                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:uuid</to>
                                                                                    </copy>
                                                                                    <copy ignoreMissingFromData="yes">
                                                                                        <from>$varValidatePaymentRq/ns4:Payment[1]/ns4:RfcIssuer</from>
                                                                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:emisorRfc</to>
                                                                                    </copy>
                                                                                    <copy ignoreMissingFromData="yes">
                                                                                        <from>$varValidatePaymentRq/ns4:Payment[1]/ns4:RfcReceiver</from>
                                                                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:receptorRfc</to>
                                                                                    </copy>
                                                                                    <copy ignoreMissingFromData="yes">
                                                                                        <from>'Validacion Automatica'</from>
                                                                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:createdBy</to>
                                                                                    </copy>
                                                                                </assign>
                                                                                <invoke name="InsertarDatosValidationAuto"
                                                                                        partnerLink="ValidationAutomatTec"
                                                                                        portType="ns11:ERPValidacionConsultBS_ptt"
                                                                                        operation="MergeReportValidation"
                                                                                        inputVariable="MergeReportValidationRq"
                                                                                        bpelx:invokeAsDetail="no"
                                                                                        outputVariable="MergeReportValidationRs"/>
                                                                            </sequence>
                                                                        </scope>
                                                                    </sequence>
                                                                </scope>
                                                            </sequence>
                                                            <else>
                                                                <documentation>
                                                                    <![CDATA[InvalidDecode]]>
                                                                </documentation>
                                                                <empty name="empty"/>
                                                            </else>
                                                        </if>
                                                    </sequence>
                                                </scope>
                                            </forEach>
                                        </sequence>
                                        <else>
                                            <documentation>
                                                <![CDATA[Ignore]]>
                                            </documentation>
                                            <assign name="assignError">
                                                <copy bpelx:insertMissingToData="yes">
                                                    <from>false()</from>
                                                    <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varContinue</to>
                                                </copy>
                                                <copy bpelx:insertMissingToData="yes">
                                                    <from><literal>SOA-00013</literal></from>
                                                    <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varError/cmn:ErrorCode</to>
                                                </copy>
                                                <copy bpelx:insertMissingToData="yes">
                                                    <from>'Invoice without attachments.'</from>
                                                    <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varError/cmn:ShortDescription</to>
                                                </copy>
                                                <copy ignoreMissingFromData="yes" bpelx:insertMissingToData="yes">
                                                    <from>concat('Invoice without attachments, InvoiceID: ',$varInvoiceAP/ns2:InvoiceId, ' InvoiceNumber: ',$varInvoiceAP/ns2:InvoiceNumber,'&lt;br/&gt;')</from>
                                                    <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varError/cmn:Description</to>
                                                </copy>
                                                <copy bpelx:insertMissingToData="yes">
                                                    <from><literal>ValidateInvoicesAP</literal></from>
                                                    <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varError/cmn:BusinessProcess</to>
                                                </copy>
                                                <copy bpelx:insertMissingToData="yes">
                                                    <from><literal>InvoicesBiz</literal></from>
                                                    <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varError/cmn:FailedService</to>
                                                </copy>
                                                <copy bpelx:insertMissingToData="yes">
                                                    <from>xp20:current-dateTime()</from>
                                                    <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varError/cmn:TimeStamp</to>
                                                </copy>
                                                <extensionAssignOperation>
                                                    <bpelx:append ignoreMissingFromData="yes">
                                                        <bpelx:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varError</bpelx:from>
                                                        <bpelx:to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$outputVariable.payload/cmn:Errors</bpelx:to>
                                                    </bpelx:append>
                                                </extensionAssignOperation>
                                                <copy ignoreMissingFromData="yes" bpelx:insertMissingToData="yes">
                                                    <from>$varCountErrors +1</from>
                                                    <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varCountErrors</to>
                                                </copy>
                                            </assign>
                                        </else>
                                    </if>
                                    <if name="If_ValidaSinXML">
                                        <condition>count($InvokeValidatiAutomOutPut.request/ns11:invoiceId)=0</condition>
                                        <sequence name="Sequence7"><assign name="TrValidationAuto"
                                                    xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable">
      <bpelx:annotation xmlns:bpelx="http://schemas.oracle.com/bpel/extension">
         <bpelx:pattern patternName="bpelx:transformation"></bpelx:pattern>
      </bpelx:annotation>
      <copy>
         <from>ora:doXSLTransformForDoc("../Transformations/trWsValidationAutomaticaTecMepearOracleXml_1.xsl", $varInvoiceAP, "invokeWsSOAUtilitiesTecDecodeRq.DecodeRq", $invokeWsSOAUtilitiesTecDecodeRq.DecodeRq)</from>
         <to variable="InvokeValidatiAutomIntPut" part="request"/>
      </copy>
   </assign>
                                            <invoke name="InvokeValidatiAutom" partnerLink="ValidationAutomatTec"
                                                    portType="ns10:ERPValidacionConsultBS_ptt"
                                                    operation="ValidaOracleXml"
                                                    inputVariable="InvokeValidatiAutomIntPut"
                                                    outputVariable="InvokeValidatiAutomOutPut" bpelx:invokeAsDetail="no"
                                                    xmlns:bpelx="http://schemas.oracle.com/bpel/extension"
                                                    xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable"/>
                                            <if name="If_SendEmailValidation"
                                                xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable">
      <documentation>
         <![CDATA[notifaction]]>
      </documentation>
      <condition>count($InvokeValidatiAutomOutPut.request/ns11:invoiceId)&gt;0</condition>
      <extensionActivity>
         <bpelx:call name="SendNotifacation"
                     xmlns:sp1="http://soa.estrellaroja.com.mx/InvoicesBiz/sbpelSenNotificationValidation"
                     target="sp1:sbpelSenNotificationValidation" xmlns:bpelx="http://schemas.oracle.com/bpel/extension">
            
            
            
         <bpelx:param name="v_ValidationRs" copyByValue="yes" variable="InvokeValidatiAutomOutPut"/><bpelx:param name="varInvoiceAP"
                                                                                                                 copyByValue="yes"
                                                                                                                 variable="varInvoiceAP"/><bpelx:param name="varUUID"
                                                                                                                                                       copyByValue="yes">'NULL'</bpelx:param></bpelx:call>
      </extensionActivity>
   </if>
                                            <if name="ifValidationAutomat"
                                                xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable">
      <documentation>
         <![CDATA[ValidaFactura]]>
      </documentation>
      <condition expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$InvokeValidatiAutomOutPut.request/ns11:success = 'true'</condition>
      <sequence name="SequenceValdarFactura">
                                                    <bpelx:skipCondition>$v_pruebas</bpelx:skipCondition>
                                                    <if name="If_generaDistribuciones">
            <condition>dvm:lookupValue("DVMs/dvmInvoicesBiz.dvm","Code","generarDistribuciones","Value","","Component","ValidateInvoicesAP")='true'</condition>
            <sequence name="Sequence5">
               <assign name="Assign1">
                                                                <copy>
                                                                    <from>'generateDistributions'</from>
                                                                    <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$wsERPintegrationApiTec_postInvoiceRq.request/name</to>
                                                                </copy>
                                                                <copy>
                                                                    <from>'VALIDADO'</from>
                                                                    <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:status</to>
                                                                </copy>
                                                                <copy>
                                                                    <from>$InvokeValidatiAutomIntPut.request/ns11:number</from>
                                                                    <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$wsERPintegrationApiTec_postInvoiceRq.request/parameters/InvoiceNumber</to>
                                                                </copy>
                                                                <copy>
                                                                    <from>$InvokeValidatiAutomIntPut.request/ns11:businessUnit</from>
                                                                    <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$wsERPintegrationApiTec_postInvoiceRq.request/parameters/BusinessUnit</to>
                                                                </copy>
                                                                <copy>
                                                                    <from>$InvokeValidatiAutomIntPut.request/ns11:supplier/ns11:name</from>
                                                                    <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$wsERPintegrationApiTec_postInvoiceRq.request/parameters/Supplier</to>
                                                                </copy>
                                                            </assign>
               <invoke name="wsERPintegrationApiTec" partnerLink="wsERPIntegrationApiTec"
                       portType="ns17:postInvoicePortType" operation="postInvoice"
                       inputVariable="wsERPintegrationApiTec_postInvoiceRq"
                       outputVariable="wsERPintegrationApiTec_postInvoiceRs" bpelx:invokeAsDetail="no"
                       xmlns:bpelx="http://schemas.oracle.com/bpel/extension"/>
            </sequence>
         </if>
         <if name="If_generarImpuestos">
            <condition>dvm:lookupValue("DVMs/dvmInvoicesBiz.dvm","Code","calcularImpuestos","Value","","Component","ValidateInvoicesAP")='true'</condition>
            <sequence name="Sequence6">
               <assign name="Assign2">
                  <copy>
                     <from>'calculateTax'</from>
                     <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$wsERPintegrationApiTec_postInvoiceRq.request/name</to>
                  </copy>
               </assign>
               <invoke name="wsErpIntegrationApiTec" partnerLink="wsERPIntegrationApiTec"
                       portType="ns17:postInvoicePortType" operation="postInvoice"
                       inputVariable="wsERPintegrationApiTec_postInvoiceRq"
                       outputVariable="wsERPintegrationApiTec_postInvoiceRs" bpelx:invokeAsDetail="no"
                       xmlns:bpelx="http://schemas.oracle.com/bpel/extension"/>
            </sequence>
         </if>
         <assign name="TrValidationInvoice">
            <bpelx:annotation xmlns:bpelx="http://schemas.oracle.com/bpel/extension">
               <bpelx:pattern patternName="bpelx:transformation"></bpelx:pattern>
            </bpelx:annotation>
            <copy>
               <from>ora:doXSLTransformForDoc("../Transformations/TransformationValidationAutomaticaERPCloud_1.xsl", $varInvoiceAP)</from>
               <to variable="submitIntPut" part="parameters"/>
            </copy>
         </assign>
         <invoke name="InvValidateInvoiceAP" bpelx:invokeAsDetail="no" partnerLink="wsErpIntegrationServicevA"
                 portType="ns12:ErpIntegrationService" operation="submitESSJobRequest" inputVariable="submitIntPut"
                 outputVariable="submitOutPut" xmlns:bpelx="http://schemas.oracle.com/bpel/extension"/>
      </sequence>
      <elseif>
         <documentation>
            <![CDATA[RetieneFactura]]>
         </documentation>
         <condition expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$InvokeValidatiAutomOutPut.request/ns11:mustModify = 'true'</condition>
         <sequence name="SequenceRetenerFactura">
                                                        <bpelx:skipCondition>$v_pruebas</bpelx:skipCondition>
                                                        <assign name="AsRetecionInvoice">
                                                            <copy>
                                                                <from>$InvokeValidatiAutomOutPut.request/ns11:oracleLookupCode</from>
                                                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$RetieneFacInt.parameters/ns14:releaseLookupCode</to>
                                                            </copy>
                                                            <copy>
                                                                <from>'RETENIDO'</from>
                                                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:status</to>
                                                            </copy>
                                                            <copy>
                                                                <from>$InvokeValidatiAutomOutPut.request/ns11:oracleLookupCode</from>
                                                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$RetieneFacInt.parameters/ns14:holdLookupCode</to>
                                                            </copy>
                                                            <copy>
                                                                <from>''</from>
                                                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$RetieneFacInt.parameters/ns14:voucherNumber</to>
                                                            </copy>
                                                            <copy>
                                                                <from>$varInvoiceAP/ns2:BusinessUnit</from>
                                                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$RetieneFacInt.parameters/ns14:businessUnitName</to>
                                                            </copy>
                                                            <copy>
                                                                <from>$varInvoiceAP/ns2:SupplierName</from>
                                                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$RetieneFacInt.parameters/ns14:supplierName</to>
                                                            </copy>
                                                            <copy>
                                                                <from>$varInvoiceAP/ns2:SupplierNumber</from>
                                                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$RetieneFacInt.parameters/ns14:supplierNumber</to>
                                                            </copy>
                                                            <copy>
                                                                <from>$varInvoiceAP/ns2:InvoiceNumber</from>
                                                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$RetieneFacInt.parameters/ns14:invoiceNumber</to>
                                                            </copy>
                                                        </assign>
            <invoke name="RetieneFacturaAP" partnerLink="wsInvoiceServiceCr" portType="ns13:InvoiceService"
                    operation="releaseSingleHold" inputVariable="RetieneFacInt" outputVariable="RetieneFacOut"
                    bpelx:invokeAsDetail="no" xmlns:bpelx="http://schemas.oracle.com/bpel/extension"/>
         </sequence>
      </elseif>
      <elseif>
         <documentation>
            <![CDATA[CancelaFactura]]>
         </documentation>
         <condition expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$InvokeValidatiAutomOutPut.request/ns11:mustCancel = 'true'</condition>
         <sequence name="Sequence4">
                                                        <bpelx:skipCondition>$v_pruebas</bpelx:skipCondition>
                                                        <extensionActivity xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable">
               <bpelx:call name="callSBpelReleaseInvoicesAP"
                           xmlns:sp1="http://soa.estrellaroja.com.mx/InvoicesBiz/sbpelReleaseInvoicesAP"
                           target="sp1:sbpelReleaseInvoicesAP" xmlns:bpelx="http://schemas.oracle.com/bpel/extension">
                  <bpelx:param name="varReleaseInvoicesAP" copyByValue="yes">$inputVariable.payload</bpelx:param>
               </bpelx:call>
            </extensionActivity>
            <assign name="AsCancelValidatinERP">
                                                            <copy>
                                                                <from>$varInvoiceAP/ns2:BusinessUnit</from>
                                                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$CancelInvoiceInt.parameters/ns14:businessUnitName</to>
                                                            </copy>
                                                            <copy>
                                                                <from>'CANCELADO'</from>
                                                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:status</to>
                                                            </copy>
                                                            <copy>
                                                                <from>$varInvoiceAP/ns2:SupplierName</from>
                                                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$CancelInvoiceInt.parameters/ns14:supplierName</to>
                                                            </copy>
                                                            <copy>
                                                                <from>$varInvoiceAP/ns2:SupplierNumber</from>
                                                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$CancelInvoiceInt.parameters/ns14:supplierNumber</to>
                                                            </copy>
                                                            <copy>
                                                                <from>$varInvoiceAP/ns2:InvoiceNumber</from>
                                                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$CancelInvoiceInt.parameters/ns14:invoiceNumber</to>
                                                            </copy>
                                                            <copy>
                                                                <from>''</from>
                                                                <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$CancelInvoiceInt.parameters/ns14:voucherNumber</to>
                                                            </copy>
                                                        </assign>
            <invoke name="CancelarFacturaAP" partnerLink="wsInvoiceServiceCr" portType="ns13:InvoiceService"
                    operation="cancelInvoice" inputVariable="CancelInvoiceInt" outputVariable="CancelInvoiceOut"
                    bpelx:invokeAsDetail="no" xmlns:bpelx="http://schemas.oracle.com/bpel/extension"/>
         </sequence>
      </elseif>
      <else>
         <empty name="EmptyValidationAutom"/>
      </else>
   </if>
                                            <scope name="ScopeMergeTP2"
                                                   xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable">
      <sequence name="SequenceMergeTP"><assign name="InsertaValidation"
                                               xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable">
                                                        <copy ignoreMissingFromData="yes">
                                                            <from>xp20:current-dateTime()</from>
                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:creationDate</to>
                                                        </copy>
                                                        <copy>
                                                            <from>'NULL'</from>
                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:uuid</to>
                                                        </copy>
                                                        <copy ignoreMissingFromData="yes">
                                                            <from>concat($varInvoiceAP/ns2:InvoiceAwtGroupCode,'-',$varInvoiceAP/ns2:InvoiceAwtPercentageRate)</from>
                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:ish</to>
                                                        </copy>
                                                        <copy ignoreMissingFromData="yes">
                                                            <from>$InvokeValidatiAutomOutPut.request/ns11:message</from>
                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:estatusValidacionDesc</to>
                                                        </copy>
                                                        <copy ignoreMissingFromData="yes">
                                                            <from>$InvokeValidatiAutomOutPut.request/ns11:success</from>
                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:estatusValidacion</to>
                                                        </copy>
                                                        <copy ignoreMissingFromData="yes">
                                                            <from>$varInvoiceAP/ns2:Total</from>
                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:attribute2</to>
                                                        </copy>
                                                        <copy ignoreMissingFromData="yes">
                                                            <from>$varValidatePaymentRq/ns4:Payment[1]/ns4:RetenidoISR</from>
                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:retenidoIsr</to>
                                                        </copy>
                                                        <copy ignoreMissingFromData="yes">
                                                            <from>$varValidatePaymentRq/ns4:Payment[1]/ns4:RetenidoIVA</from>
                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:retenidoIva</to>
                                                        </copy>
                                                        <copy ignoreMissingFromData="yes">
                                                            <from>$varValidatePaymentRq/ns4:Payment[1]/ns4:Importe</from>
                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:iva8</to>
                                                        </copy>
                                                        <copy ignoreMissingFromData="yes">
                                                            <from>$varValidatePaymentRq/ns4:Payment/ns4:TotalAmount</from>
                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:total</to>
                                                        </copy>
                                                        <copy ignoreMissingFromData="yes">
                                                            <from>$varValidatePaymentRq/ns4:Payment[1]/ns4:Importeieps</from>
                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:combustible</to>
                                                        </copy>
                                                        <copy ignoreMissingFromData="yes">
                                                            <from>$varValidatePaymentRq/ns4:Payment[1]/ns4:Impuestoieps</from>
                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:totalIeps</to>
                                                        </copy>
                                                        <copy ignoreMissingFromData="yes">
                                                            <from>$varValidatePaymentRq/ns4:Payment[1]/ns4:Impuesto</from>
                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:iva16</to>
                                                        </copy>
                                                        <copy ignoreMissingFromData="yes">
                                                            <from>$varInvoiceAP/ns2:InvoiceId</from>
                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:invoiceId</to>
                                                        </copy>
                                                        <copy ignoreMissingFromData="yes">
                                                            <from>$varInvoiceAP/ns2:BusinessUnit</from>
                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:businessUnit</to>
                                                        </copy>
                                                        <copy ignoreMissingFromData="yes">
                                                            <from>$varInvoiceAP/ns2:BusinessUnit</from>
                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:unidadNegocio</to>
                                                        </copy>
                                                        <copy ignoreMissingFromData="yes">
                                                            <from>$varInvoiceAP/ns2:SupplierName</from>
                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:attribute5</to>
                                                        </copy>
                                                        <copy ignoreMissingFromData="yes">
                                                            <from>$varInvoiceAP/ns2:CreationDate</from>
                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:attribute4</to>
                                                        </copy>
                                                        <copy ignoreMissingFromData="yes">
                                                            <from>$varValidatePaymentRq/ns4:Payment[1]/ns4:InformacionAduanera</from>
                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:attribute3</to>
                                                        </copy>
                                                        <copy ignoreMissingFromData="yes">
                                                            <from>$varValidatePaymentRq/ns4:Payment[1]/ns4:RFCEmisor</from>
                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:attribute1</to>
                                                        </copy>
                                                        <copy ignoreMissingFromData="yes">
                                                            <from>$varInvoiceAP/ns2:InvoiceNumber</from>
                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:invoiceNumber</to>
                                                        </copy>
                                                        <copy ignoreMissingFromData="yes">
                                                            <from>$varInvoiceAP/ns2:SupplierNumber</from>
                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:supplierNumber</to>
                                                        </copy>
                                                        <copy ignoreMissingFromData="yes">
                                                            <from>$varInvoiceAP/ns2:SupplierSiteCode</from>
                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:sitioProveedor</to>
                                                        </copy>
                                                        <copy ignoreMissingFromData="yes">
                                                            <from>$varInvoiceAP/ns2:details[1]/ns2:gccSegment3</from>
                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:tercerSegmCotable</to>
                                                        </copy>
                                                        <copy ignoreMissingFromData="yes">
                                                            <from>$varInvoiceAP/ns2:details[1]/ns2:gccSegment5</from>
                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:quintoSegmContable</to>
                                                        </copy>
                                                        <copy ignoreMissingFromData="yes">
                                                            <from>$varInvoiceAP/ns2:SupplierName</from>
                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:nombreEmisor</to>
                                                        </copy>
                                                        <copy ignoreMissingFromData="yes">
                                                            <from>$varValidatePaymentRq/ns4:Payment[1]/ns4:SubTotal</from>
                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:subtotal</to>
                                                        </copy>
                                                        <copy ignoreMissingFromData="yes">
                                                            <from>$varValidatePaymentRq/ns4:Payment[1]/ns4:DescripcionL</from>
                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:conceptos</to>
                                                        </copy>
                                                        <copy ignoreMissingFromData="yes">
                                                            <from>$varValidatePaymentRq/ns4:Payment[1]/ns4:Moneda</from>
                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:moneda</to>
                                                        </copy>
                                                        <copy ignoreMissingFromData="yes">
                                                            <from>$inputVariable.payload/ns2:InvoicesAP/ns2:InvoiceAP/ns2:Total</from>
                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:amount</to>
                                                        </copy>
                                                        <copy ignoreMissingFromData="yes">
                                                            <from>$varValidatePaymentRq/ns4:Payment[1]/ns4:CuentaPredial</from>
                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:lastUpdatedBy</to>
                                                        </copy>
                                                        <copy ignoreMissingFromData="yes">
                                                            <from>$varValidatePaymentRq/ns4:Payment[1]/ns4:TipoDeComprobante</from>
                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:tipoComprobante</to>
                                                        </copy>
                                                        <copy ignoreMissingFromData="yes">
                                                            <from>$varValidatePaymentRq/ns4:Payment[1]/ns4:FechaTimbrado</from>
                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:fechaTimbrado</to>
                                                        </copy>
                                                        <copy ignoreMissingFromData="yes">
                                                            <from>$varValidatePaymentRq/ns4:Payment[1]/ns4:TipoRelacion</from>
                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:tipoRelacion</to>
                                                        </copy>
                                                        <copy ignoreMissingFromData="yes">
                                                            <from>$varValidatePaymentRq/ns4:Payment[1]/ns4:UUIDRelacion</from>
                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:uuidRelacion</to>
                                                        </copy>
                                                        <copy ignoreMissingFromData="yes">
                                                            <from>$varValidatePaymentRq/ns4:Payment[1]/ns4:Descuento</from>
                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:descuento</to>
                                                        </copy>
                                                        <copy ignoreMissingFromData="yes">
                                                            <from>$varValidatePaymentRq/ns4:Payment[1]/ns4:TipoCambio</from>
                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:tipoCambio</to>
                                                        </copy>
                                                        <copy ignoreMissingFromData="yes">
                                                            <from>$varValidatePaymentRq/ns4:Payment[1]/ns4:MetodoPago</from>
                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:metodoPago</to>
                                                        </copy>
                                                        <copy ignoreMissingFromData="yes">
                                                            <from>$varValidatePaymentRq/ns4:Payment[1]/ns4:FormaPago</from>
                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:formaPago</to>
                                                        </copy>
                                                        <copy ignoreMissingFromData="yes">
                                                            <from>$varValidatePaymentRq/ns4:Payment[1]/ns4:UsoCFDI</from>
                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:usoCfdi</to>
                                                        </copy>
                                                        <copy ignoreMissingFromData="yes">
                                                            <from>$inputVariable.payload/ns2:InvoicesAP/ns2:InvoiceAP/ns2:SupplierRFC</from>
                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:emisorRfc</to>
                                                        </copy>
                                                        <copy ignoreMissingFromData="yes">
                                                            <from>$inputVariable.payload/ns2:InvoicesAP/ns2:InvoiceAP/ns2:ReceptorRFC</from>
                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:receptorRfc</to>
                                                        </copy>
                                                        <copy ignoreMissingFromData="yes">
                                                            <from>'Validacion Automatica'</from>
                                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$MergeReportValidationRq.request/ns11:createdBy</to>
                                                        </copy>
                                                    </assign><invoke name="InsertarDatosValidationAuto" partnerLink="ValidationAutomatTec"
                 portType="ns11:ERPValidacionConsultBS_ptt" operation="MergeReportValidation"
                 inputVariable="MergeReportValidationRq" bpelx:invokeAsDetail="no"
                 outputVariable="MergeReportValidationRs" xmlns:bpelx="http://schemas.oracle.com/bpel/extension"/>
      </sequence>
   </scope>
                                        </sequence>
                                        <else>
                                            <empty name="EmptyYaEjecuto"/>
                                        </else>
                                    </if>
                                </sequence>
                                <else>
                                    <documentation>
                                        <![CDATA[InvalidInvoice]]>
                                    </documentation>
                                    <assign name="assignError">
                                        <copy bpelx:insertMissingToData="yes">
                                            <from><literal>SOA-00012</literal></from>
                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varError/cmn:ErrorCode</to>
                                        </copy>
                                        <copy bpelx:insertMissingToData="yes" ignoreMissingFromData="yes">
                                            <from>'Invalid Invoice'</from>
                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varError/cmn:ShortDescription</to>
                                        </copy>
                                        <copy bpelx:insertMissingToData="yes" ignoreMissingFromData="yes">
                                            <from>concat('InvoiceID:  ',$varInvoiceAP/ns2:InvoiceId, ' InvoiceNumber: ',$varInvoiceAP/ns2:InvoiceNumber,'&lt;br/&gt;')</from>
                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varError/cmn:Description</to>
                                        </copy>
                                        <copy bpelx:insertMissingToData="yes">
                                            <from><literal>ValidateInvoicesAP</literal></from>
                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varError/cmn:BusinessProcess</to>
                                        </copy>
                                        <copy bpelx:insertMissingToData="yes">
                                            <from><literal>InvoicesBiz</literal></from>
                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varError/cmn:FailedService</to>
                                        </copy>
                                        <copy bpelx:insertMissingToData="yes" ignoreMissingFromData="yes">
                                            <from>xp20:current-dateTime()</from>
                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varError/cmn:TimeStamp</to>
                                        </copy>
                                        <extensionAssignOperation>
                                            <bpelx:append ignoreMissingFromData="yes">
                                                <bpelx:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varError</bpelx:from>
                                                <bpelx:to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$outputVariable.payload/cmn:Errors</bpelx:to>
                                            </bpelx:append>
                                        </extensionAssignOperation>
                                        <copy ignoreMissingFromData="yes" bpelx:insertMissingToData="yes">
                                            <from>$varCountErrors + 1</from>
                                            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varCountErrors</to>
                                        </copy>
                                    </assign>
                                </else>
                            </if>
                        </sequence>
                    </scope>
                </forEach>
                <scope name="ScopeWsValidate">
                    <variables>
                        <variable name="varValidatePaymentsRs" element="ns4:ValidatePaymenyRs"/>
                        <variable name="varCancelInvoicesRq" element="ns4:CancelInvoicesAPRq"/>
                        <variable name="varUploadAttachmentsRq" element="ns4:UploadAttachmentsRq"/>
                        <variable name="varUploadAttachmentsRs" element="ns4:UploadAttachmentsRs"/>
                        <variable name="invokeAuditControlTecMergeInvoicesAPRq" messageType="ns7:MergeInvoicesAPRq"/>
                        <variable name="invokeAuditControlTecMergeInvoicesAPRs" messageType="ns7:MergeInvoicesAPRs"/>
                    </variables>
                    <sequence name="sequenceValidatePayments">
                        <if name="ifExistValidatePayments">
                            <documentation>
                                <![CDATA[true]]>
                            </documentation>
                            <condition expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">count($varValidatePaymentRq/ns4:Payment) &gt; 0</condition>
                            <sequence name="sequenceValidatePayments">
                                <empty name="Empty1"/>
                            </sequence>
                            <else>
                                <documentation>
                                    <![CDATA[false]]>
                                </documentation>
                                <empty name="empty"/>
                            </else>
                        </if>
                        <extensionActivity>
                            <bpelx:call name="callSBpelReleaseInvoicesAP"
                                        xmlns:sp1="http://soa.estrellaroja.com.mx/InvoicesBiz/sbpelReleaseInvoicesAP"
                                        target="sp1:sbpelReleaseInvoicesAP">
                                <bpelx:skipCondition>$v_pruebas</bpelx:skipCondition>
                                <bpelx:param name="varReleaseInvoicesAP" copyByValue="yes">$inputVariable.payload</bpelx:param>
                            </bpelx:call>
                        </extensionActivity>
                        <if name="ifExistErrors">
                            <bpelx:skipCondition>$v_pruebas</bpelx:skipCondition>
                            <documentation>
                                <![CDATA[Errors]]>
                            </documentation>
                            <condition expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">count($varValidatePaymentsRs//cmn:Success) &gt; 0 and $varValidatePaymentsRs//ns4:Valid = false()</condition>
                            <sequence name="sequenceCancelInvoices">
                                <assign name="xqyVarValidatePaymentsRs_To_VarCancelInvoicesRq">
                                    <bpelx:annotation>
                                        <bpelx:pattern patternName="bpelx:xquery"></bpelx:pattern>
                                    </bpelx:annotation>
                                    <copy>
                                        <from>ora:processXQuery10('../Transformations/XQueries/xqyVarValidatePaymentsRs_To_VarCancelInvoicesRq.xqy', 'varValidatePaymentsRs', $varValidatePaymentsRs, 'inputVariable.payload', $inputVariable.payload)</from>
                                        <to variable="varCancelInvoicesRq"/>
                                    </copy>
                                </assign>
                                <extensionActivity>
                                    <bpelx:call name="callSBpelCancelInvoices"
                                                xmlns:sp1="http://soa.estrellaroja.com.mx/InvoicesBiz/sbpelCancelInvoicesAP"
                                                target="sp1:sbpelCancelInvoicesAP">
                                        <bpelx:param name="varCancelInvoicesAPRq" copyByValue="yes"
                                                     variable="varCancelInvoicesRq"/>
                                    </bpelx:call>
                                </extensionActivity>
                            </sequence>
                            <else>
                                <documentation>
                                    <![CDATA[Success]]>
                                </documentation>
                                <empty name="empty"/>
                            </else>
                        </if>
                        <if name="ifExistValidInvoice">
                            <documentation>
                                <![CDATA[UploadAttachments]]>
                            </documentation>
                            <condition expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">count($varValidatePaymentsRs//cmn:Success) &gt; 0</condition>
                            <sequence name="sequenceUploadAttachments">
                                <assign name="xqyValidatePaymentsRs_To_UploadAttachmentsRq">
                                    <bpelx:annotation>
                                        <bpelx:pattern patternName="bpelx:xquery"></bpelx:pattern>
                                    </bpelx:annotation>
                                    <copy>
                                        <from>ora:processXQuery10('../Transformations/XQueries/xqyValidatePaymentsRs_To_UploadAttachmentsRq.xqy', 'varValidatePaymentsRs', $varValidatePaymentsRs, 'inputVariable.payload', $inputVariable.payload, 'varValidatePaymentRq', $varValidatePaymentRq)</from>
                                        <to variable="varUploadAttachmentsRq"/>
                                    </copy>
                                </assign>
                                <assign name="assignCommonsParams">
                                    <!--copy ignoreMissingFromData="yes" bpelx:insertMissingToData="yes">
                                        <from>'yes'</from>
                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varUploadAttachmentsRq/ns1:allowDuplicate</to>
                                    </copy>
                                    <copy bpelx:insertMissingToData="yes" ignoreMissingFromData="yes">
                                        <from>$varInvoiceAP/ns2:BusinessUnit</from>
                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varUploadAttachmentsRq/ns1:attachmentRows/ns1:UserKeyA</to>
                                    </copy>
                                    <copy ignoreMissingFromData="yes" bpelx:insertMissingToData="yes">
                                        <from>$varInvoiceAP/ns2:InvoiceNumber</from>
                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varUploadAttachmentsRq/ns1:attachmentRows/ns1:UserKeyB</to>
                                    </copy>
                                    <copy ignoreMissingFromData="yes" bpelx:insertMissingToData="yes">
                                        <from>$varInvoiceAP/ns2:SupplierNumber</from>
                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varUploadAttachmentsRq/ns1:attachmentRows/ns1:UserKeyC</to>
                                    </copy>
                                    <copy ignoreMissingFromData="yes" bpelx:insertMissingToData="yes">
                                        <from><literal>TEXT</literal></from>
                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varUploadAttachmentsRq/ns1:attachmentRows/ns1:AttachmentType</to>
                                    </copy>
                                    <copy ignoreMissingFromData="yes" bpelx:insertMissingToData="yes">
                                        <from>concat(substring-before($varValidatePaymentsRs/ns4:Return/ns4:Payment/ns4:StatusDesc,'-'),'- ',xp20:day-from-dateTime(xp20:current-dateTime()),xp20:month-from-dateTime(xp20:current-dateTime()),xp20:year-from-dateTime(xp20:current-dateTime()),'_',$varValidatePaymentRq/ns4:Payment/ns4:Uuid)</from>
                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varUploadAttachmentsRq/ns1:attachmentRows/ns1:Title</to>
                                    </copy>
                                    <copy ignoreMissingFromData="yes" bpelx:insertMissingToData="yes">
                                        <from>$varValidatePaymentsRs/ns4:Return/ns4:Payment/ns4:XmlContent</from>
                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varUploadAttachmentsRq/ns1:attachmentRows/ns1:Content</to>
                                    </copy-->
                                    <copy ignoreMissingFromData="yes" bpelx:insertMissingToData="yes">
                                        <from>dvm:lookupValue("DVMs/dvmInvoicesBiz.dvm","Code","paramEntity","Value","","Component","ValidateInvoicesAP")</from>
                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varUploadAttachmentsRq/ns1:entityName</to>
                                    </copy>
                                    <copy ignoreMissingFromData="yes" bpelx:insertMissingToData="yes">
                                        <from>dvm:lookupValue("DVMs/dvmInvoicesBiz.dvm","Code","paramCategoryName","Value","","Component","ValidateInvoicesAP")</from>
                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varUploadAttachmentsRq/ns1:categoryName</to>
                                    </copy>
                                </assign>
                                <extensionActivity>
                                    <bpelx:call name="callSBpelUploadAttachments"
                                                xmlns:sp1="http://soa.estrellaroja.com.mx/InvoicesBiz/sbpelUploadAttachments"
                                                target="sp1:sbpelUploadAttachments">
                                        <bpelx:param name="varUploadAttachmentsRq" copyByValue="yes"
                                                     variable="varUploadAttachmentsRq"/>
                                        <bpelx:param name="varUploadAttachmentsRs" copyByValue="no"
                                                     variable="varUploadAttachmentsRs"/>
                                    </bpelx:call>
                                </extensionActivity>
                                <assign name="assignResult">
                                    <copy bpelx:insertMissingToData="yes" ignoreMissingFromData="yes">
                                        <from>$varCountSuccess + count($varUploadAttachmentsRs//ns4:ValidInvoice)</from>
                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varCountSuccess</to>
                                    </copy>
                                    <copy bpelx:insertMissingToData="yes" ignoreMissingFromData="yes">
                                        <from>$varCountErrors + count($varUploadAttachmentsRs//ns4:InvalidInvoice)</from>
                                        <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varCountErrors</to>
                                    </copy>
                                </assign>
                                <if name="ifExistErrors">
                                    <documentation>
                                        <![CDATA[CatchErrors]]>
                                    </documentation>
                                    <condition expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">count($varUploadAttachmentsRs//cmn:Errors) &gt; 0</condition>
                                    <assign name="assignErrors">
                                        <extensionAssignOperation>
                                            <bpelx:append ignoreMissingFromData="yes">
                                                <bpelx:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varUploadAttachmentsRs//cmn:Error</bpelx:from>
                                                <bpelx:to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$outputVariable.payload/cmn:Errors</bpelx:to>
                                            </bpelx:append>
                                        </extensionAssignOperation>
                                    </assign>
                                    <else>
                                        <documentation>
                                            <![CDATA[Success]]>
                                        </documentation>
                                        <empty name="empty"/>
                                    </else>
                                </if>
                                <if name="ifSuccessUploadAttachment">
                                    <documentation>
                                        <![CDATA[SaveProcessedInvoices]]>
                                    </documentation>
                                    <condition expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">count($varUploadAttachmentsRs//cmn:Success)&gt;0</condition>
                                    <sequence name="sequenceSaveProcessedInvoices">
                                        <assign name="xqyUploadAttachmentsRs_To_WsAuditControlTecMergeInvoicesAPRq">
                                            <bpelx:annotation>
                                                <bpelx:pattern patternName="bpelx:xquery"></bpelx:pattern>
                                            </bpelx:annotation>
                                            <copy>
                                                <from>ora:processXQuery10('../Transformations/XQueries/xqyUploadAttachmentsRs_To_WsAuditControlTecMergeInvoicesAPRq.xqy', 'InvokeValidatiAutomOutPut.request', $InvokeValidatiAutomOutPut.request, 'varUploadAttachmentsRs', $varUploadAttachmentsRs, 'varValidatePaymentRq', $varValidatePaymentRq, 'inputVariable.payload', $inputVariable.payload)</from>
                                                <to variable="invokeAuditControlTecMergeInvoicesAPRq"
                                                    part="MergeInvoicesAPRq"/>
                                            </copy>
                                        </assign>
                                        <invoke name="invokeAuditControlTecMergeInvoicesAP"
                                                partnerLink="wsAuditControlTecPs" portType="ns7:AuditControlTecPortType"
                                                operation="MergeInvoicesAP"
                                                inputVariable="invokeAuditControlTecMergeInvoicesAPRq"
                                                outputVariable="invokeAuditControlTecMergeInvoicesAPRs"
                                                bpelx:invokeAsDetail="no"/>
                                    </sequence>
                                    <else>
                                        <documentation>
                                            <![CDATA[NothingToDo]]>
                                        </documentation>
                                        <empty name="empty"/>
                                    </else>
                                </if>
                            </sequence>
                            <else>
                                <documentation>
                                    <![CDATA[InvalidInvoices]]>
                                </documentation>
                                <empty name="empty"/>
                            </else>
                        </if>
                    </sequence>
                </scope>
                <if name="ifExistInvoices">
                    <documentation>
                        <![CDATA[SendNotification]]>
                    </documentation>
                    <condition expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$varCountTotal &gt;0</condition>
                    <sequence name="sequenceSendNotification">
                        <assign name="trCounterRq_To_SbpelNotificationHtmlControlRq">
                            <bpelx:annotation>
                                <bpelx:pattern patternName="bpelx:transformation"></bpelx:pattern>
                            </bpelx:annotation>
                            <copy>
                                <from>ora:doXSLTransformForDoc("../Transformations/XSLs/trCounterRq_To_SbpelNotificationHtmlControlRq.xsl", $outputVariable.payload, "varCountTotal", $varCountTotal, "varCountErrors", $varCountErrors, "varCountSuccess", $varCountSuccess)</from>
                                <to variable="htmlInput" part="GetHtmlControlRq"/>
                            </copy>
                        </assign>
                        <extensionActivity>
                            <bpelx:call name="callSBpelNotifiyHymlControl"
                                        xmlns:sp1="http://soa.estrellaroja.com.mx/InvoicesBiz/sbpelNotifyHtmlControl"
                                        target="sp1:sbpelNotifyHtmlControl">
                                <bpelx:param name="integrationName" copyByValue="yes">dvm:lookupValue("DVMs/dvmInvoicesBiz.dvm","Code","paramIntegrationName","Value","","Component","ValidateInvoicesAP")</bpelx:param>
                                <bpelx:param name="htmlInput" copyByValue="yes" variable="htmlInput"/>
                            </bpelx:call>
                        </extensionActivity>
                    </sequence>
                    <else>
                        <documentation>
                            <![CDATA[NothingToDo]]>
                        </documentation>
                        <empty name="empty"/>
                    </else>
                </if>
            </sequence>
        </scope>
        <!-- 
          Asynchronous callback to the requester. (Note: the callback location and correlation id is transparently handled using WS-addressing.)
        -->
        <invoke name="callbackClient" partnerLink="bpelvalidateinvoicesap"
                portType="client:bpelValidateInvoicesAPCallback" operation="ValidateInvoicesAPCallback"
                inputVariable="outputVariable"/>
    </sequence>
</process>